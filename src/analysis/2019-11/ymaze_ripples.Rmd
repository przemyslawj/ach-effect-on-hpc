---
title: "R Notebook"
output: html_notebook
---
```{r}
library(purrr)
```


```{r read_data}
diode.signal = TRUE

data_dir = '/mnt/DATA/chat_ripples/y-maze/'
img_dir = '/home/prez/tmp/ymaze_chat_x_ai32/img_gen/ymaze'

if (diode.signal) {
  psddf.ymaze = read_csv(paste0(data_dir,'/','psd_table_diode_th6.csv'))
  ripples.ymaze = read_csv(paste0(data_dir,'/','ripples_diode_th6.csv'))
} else {
  psddf.ymaze = read_csv(paste0(data_dir,'/','psd_table_th6.csv'))
  ripples.ymaze = read_csv(paste0(data_dir,'/','ripples_th6.csv'))
}

psddf.ymaze = prepare.ymaze.df(psddf.ymaze)
ripples.ymaze = prepare.ymaze.df(ripples.ymaze)
```


Join trial metadata (includes if the mouse made correct choice)
```{r}
trial.info.df = read_csv(paste(data_dir, 'trials.csv', sep='/')) %>%
  dplyr::mutate(file_name=paste0('signal/', animal, '_trial_', trial, '_g0'))
trial.info.df$date = as.Date(trial.info.df$date, '%d/%m/%Y')
glimpse(trial.info.df)
```

```{r}
library(stringr)
#trial.info.df = dplyr::mutate(trial.info.df, file_name = stringr::str_replace(file_name, '_trial_', '_after_'))
psddf.ymaze = left_join(psddf.ymaze, dplyr::select(trial.info.df, -trial, -state, -laserOn), 
                        by=c('date', 'animal', 'file_name'))
ripples.ymaze = left_join(ripples.ymaze, dplyr::select(trial.info.df, -trial, -state, -laserOn), 
                        by=c('date', 'animal', 'file_name'))
```

Performance reached 70 % 
```{r}
 psddf.ymaze %>%
  group_by(animal, learning_day) %>%
  dplyr::summarise(pct.correct=mean(correct)) %>% 
  group_by(learning_day) %>%
  dplyr::summarise(mean(pct.correct),
                   sem(pct.correct))
```

```{r}
psddf.ymaze.correct = filter(psddf.ymaze, correct == 1)
```

Filter animals with fewer ripples than one
```{r}
nripples.summary = psddf.ymaze.correct %>%
  filter(laserOn == 0, learning_day >= 1, stage_desc == 'Total', channelLocation == 'CA1') %>%
  group_by(animal) %>%
  dplyr::summarise(has_ripples.pct=sum(swr_incidence > 0) / n(),
                   nripples.mean = mean(nripples)) 
psddf.ymaze.correct = filter(psddf.ymaze.correct, 
                             animal %in% subset(nripples.summary, nripples.mean >= 1)$animal)
```

Plot ripples over trial
```{r}
ripples.ymaze %>% 
  filter(correct == 1) %>% 
  filter(learning_day == 6, animal=='PT') %>%
  filter(stage_desc %in% c('StartZone', 'DuringStim')) %>%
  ggplot() +
  geom_point(aes(x=peak_t, y=trial_no, color=laserOn)) +
  facet_grid(channelLocation ~ stage_desc) +#, scales = 'free_x') +
  gtheme +
  xlab('Time (s)') + ylab('# trial')

ggsave(paste0(img_dir, '/indiv_ripples_time.svg'), units = 'cm',
       height=7, width=12)
```


```{r}
swr.ymaze.summary = psddf.ymaze.correct %>%
  group_by(animal, date, learning_day, laserOn, stage_desc, channelLocation) %>% 
  dplyr::summarise(swr_incidence.mean=mean(swr_incidence),
                   swr_incidence.sem=sem(swr_incidence),
                   has_ripples.pct=sum(swr_incidence > 0) / n(),
                   nripples.mean = mean(nripples)) 
swr.ymaze.summary$date = as.factor(swr.ymaze.summary$date)
```

```{r}
swr.ymaze.summary %>%
  #filter(stage_desc == 'DuringStim', learning_day >= 5)  %>%
  filter(stage_desc == 'DuringStim')  %>%
  dplyr::mutate(date_animal = paste(format(date), animal, sep='_'),
                date_laser_val = as.numeric(date) + (as.numeric(laserOn) - 1) * 0.5 - 0.25) %>% 
  ggplot() +
  geom_point(aes(x=date_laser_val, y=swr_incidence.mean, color=animal)) +
  geom_line(aes(x=date_laser_val, y=swr_incidence.mean, group=date_animal)) +
  geom_ribbon(aes(x=date_laser_val, 
                  ymin=swr_incidence.mean - swr_incidence.sem, 
                  ymax=swr_incidence.mean + swr_incidence.sem,
                  group=date_animal), 
                alpha=0.1) +
  xlab('Learning day') + ylab('Ripple incidence at goal (Hz)') +
  facet_grid(. ~ channelLocation) +
  gtheme

ggsave(paste0(img_dir, '/ripples_change.svg'), units = 'cm',
       height=5, width=8)
```

```{r}
swr.ymaze.summary %>% 
  filter(stage_desc == 'DuringStim')  %>%
  DT::datatable()

psddf.ymaze.correct %>%
  filter(stage_desc == 'DuringStim')  %>%
  dplyr::select(date, animal, trial, laserOn, swr_incidence, nripples) %>%
  DT::datatable()
```
Significance testing
```{r}
last2days.ymaze.correct = filter(psddf.ymaze.correct, 
                                 learning_day >= 5,
                                 channelLocation == 'CA1',
                                 stage_desc == 'DuringStim')
m.full = lmerTest::lmer(swr_incidence ~ laserOn + (1 + laserOn | animal), 
                        data=last2days.ymaze.correct, 
                        REML = TRUE) 
plot.model.diagnostics(m.full, last2days.ymaze.correct$animal, last2days.ymaze.correct$laserOn) 
summary(m.full)
coef(m.full)$animal
anova(m.full, refit=FALSE, ddf='Satterthwaite')
```



When do ripples happen: pct of runs with ripples during the stage
```{r}
swr.ymaze.summary %>% 
#psddf.ymaze.correct %>%
  filter(laserOn == 0, learning_day == 6) %>%
  filter(stage_desc %in% c('DuringStim', 'StartZone', 'FirstArm', 'BeforeGoalZone')) %>%
  ggplot() +
  facet_grid(date ~ .) +
  geom_jitter(aes(x=stage_desc, y=has_ripples.pct, color=stage_desc))

```

Ripples during a single trial
```{r}
psddf.ymaze.correct %>% 
  filter(learning_day == 6) %>%
  filter(laserOn == 0) %>%
  filter(stage_desc %in% c('StartZone', 'DuringStim')) %>% 
  dplyr::mutate(date_trial = paste(animal, format(date), file_name, sep='_')) %>%
  dplyr::select(animal, date, date_trial, stage_desc, nripples, swr_incidence, correct, channelLocation) %>%  
  ggplot(aes(x=stage_desc, y=nripples, group=date_trial, color=animal)) +
  geom_line() +
  geom_point() +
  facet_grid(correct ~ channelLocation)
```

Ripples conclusion:
CA1 DuringStim:
  signif lower for th=6 when filtered 80-250, 
  signif lower for th=5 when filtered 100-250, signif for learning_day>=5
  not signif lower for th=6 when when filtered 100-250 (p=0.07)
CA3 no signif, 
  v few ripples at 150-250Hz in CA3 th6 or th5, not signif


TODO: 
[] Replicate figure: https://www.nature.com/articles/s41593-017-0061-5/figures/3
   [x] location of SWRs: x - time, y- # trial, point for ripple
   [x] Spectrogram on ymaze? avg for a day
   
[x] not seen 20-50Hz oscillations at reward for CA3
[x] look at ymaze % correct to justify choice of learning day 5 and 6 for ripples comparioson
[x] look at the found ripples - are they good quality? are they long enough?
[x] look at all channels
[] coherence between CA1 and CA3

Problems:
[x] exclude SWRs during movement as detected from EMG

