---
title: "R Notebook"
output: html_notebook
---
```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggpubr)
library(purrr)
select = dplyr::select

library(lmerTest)
source('psd_analysis.R')
source('psd_fitting.R')

laser.col='#0098ffff'
nolaser.col='grey30'
img_dir = '/home/prez/tmp/ymaze_chat_x_ai32/img_gen/ymaze'
```

```{r}
data_dir =  '/mnt/DATA/chat_ripples/y-maze'
diode.signal = TRUE
if (diode.signal) {
  psddf.ymaze = read_csv(paste0(data_dir,'/','welch_psd_table_diode_th6.csv'))
} else {
  psddf.ymaze = read_csv(paste0(data_dir,'/','psd_table_th6.csv'))  
}
psddf.ymaze = prepare.ymaze.df(psddf.ymaze)

trial.info.df = read_csv(paste(data_dir, 'trials.csv', sep='/')) %>%
  dplyr::mutate(file_name=paste0('signal/', animal, '_trial_', trial, '_g0'))
trial.info.df$date = as.Date(trial.info.df$date, '%d/%m/%Y')

psddf.ymaze = left_join(psddf.ymaze, dplyr::select(trial.info.df, -trial, -state, -laserOn), 
                        by=c('date', 'animal', 'file_name'))

freq.bands.df = data.frame(
  band=c('theta', 'slow gamma', 'fast gamma'),
  xmin=c(5, 25, 80),
  xmax=c(9, 45, 150)
)
```

# Effect of the task stage
```{r}
band.zscore = melt.freq.bands(filter(psddf.ymaze, correct==1), 
                             extra.id.vars=c('learning_day', 'dirname'),
                             psd.vars.prefix='all_psd_z_' ) %>%
  dplyr::rename(band.zscore=band_power)

psd.molten = melt.freq.bands(filter(psddf.ymaze, correct==1), 
                             extra.id.vars=c('learning_day', 'dirname'),
                             psd.vars.prefix='all_psd_xx_')
```


```{r}
axis.breaks=c(1:9,seq(10,100,10), 200)
axis.labels=rep('', length(axis.breaks))
axis.labels[1]=1
axis.labels[10]=10
axis.labels[19]=100

band.zscore %>%
  filter(laserOn == 0) %>%
  #filter(animal == 'BS') %>%
  filter(learning_day == 6)  %>%
  filter(stage_desc %in% c('MazeStem', 'DuringStim')) %>%
  #filter(stage_desc %in% c('DuringStim')) %>%
  dplyr::mutate(trial_stage = paste0(trial_id, stage_desc, sep='_')) %>% 
  ggplot(aes(x=band_start_freq, y=band.zscore, group=trial_stage, color=stage_desc)) +
  geom_line(size=0.5*px2pt)  +
  facet_grid(laserOn ~ channelLocation) +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  gtheme
```

```{r}
animal.band.zscore = band.zscore %>%
  filter(learning_day >= 5)  %>%
  group_by(animal, channelLocation, laserOn, stage_desc, band_start_freq) %>%
  dplyr::summarise(mean.zscore = mean(band.zscore),
                   sem.zscore = sem(band.zscore))

animal.band.zscore %>%
  filter(laserOn == 0) %>%
  filter(animal == 'BS') %>%
  filter(stage_desc %in% c('MazeStem', 'GoalZone20sec')) %>%
  #filter(stage_desc %in% c('MazeStem', 'AfterConsumedReward_10_sec')) %>%
  #dplyr::mutate(animal_stage = paste0(animal, stage_desc, sep='_')) %>% 
  ggplot(aes(x=band_start_freq, y=mean.zscore, group=stage_desc)) +
  geom_line(aes(color=stage_desc), size=1*px2pt) +
  geom_ribbon(aes(ymin=mean.zscore - sem.zscore, ymax=mean.zscore + sem.zscore), alpha=0.2) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  gtheme +
  coord_flip() +
  facet_grid(laserOn ~ channelLocation) +
  xlim(2,15)+
  ylim(-1, 1.1) +
  #xlim(20, 250) +
  #ylim(-1, 1.8) +
  xlab('Frequency (Hz)') +
  ylab('Power z-score') 

ggsave(paste0(img_dir, '/psd_zscore_giht.pdf'), units = 'cm',
       dpi=300, device=cairo_pdf,
       height=4, width=10)
```

```{r}
animal.band.zscore %>%
  dplyr::mutate(animal_laser=paste(animal, laserOn, sep='_')) %>%
  #filter(learning_day >= 4)  %>%
  filter(stage_desc %in% c('GoalZone20sec')) %>%
  ggplot(aes(x=band_start_freq, y=mean.zscore, group=animal_laser)) +
  geom_line(aes(color=laserOn), size=1*px2pt) +
  #geom_ribbon(aes(ymin=mean.zscore - sem.zscore, ymax=mean.zscore + sem.zscore), alpha=0.2) +
  facet_grid(. ~ channelLocation) +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  gtheme
```
Effect of the stage on PSD
```{r}
animal.psd = psd.molten %>%
  group_by(animal, learning_day, channelLocation, laserOn, stage_desc, band_start_freq) %>%
  dplyr::summarise(mean.power = mean(log(band_power)),
                   sem.power = sem(log(band_power)))
```

```{r}
animal.psd %>%
  filter(laserOn == 0) %>%
  filter(learning_day==6) %>%
  filter(stage_desc %in% c('MazeStem', 'GoalZone20sec')) %>%
  ggplot(aes(x=band_start_freq, y=mean.power, group=stage_desc)) +
  geom_line(aes(color=stage_desc), size=2*px2pt) +
  geom_ribbon(aes(ymin=mean.power - sem.power, ymax=mean.power + sem.power), alpha=0.2) +
  facet_grid(animal ~ channelLocation) +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  gtheme +
  xlab('Frequency (Hz)') +
  ylab('Power z-score') 
```
# Laser effect 


```{r}
animal.psd = psd.molten %>%
  filter(learning_day >= 5)  %>%
  filter(animal == 'OS') %>%
  filter(stage_desc %in% c('GoalZone20sec')) %>%
  group_by(animal, channelLocation, laserOn, stage_desc, band_start_freq) %>%
  dplyr::summarise(sem.power = sem(log(band_power)),
                   band_power = mean(log(band_power)))
```


```{r}
bs.ca1.psd = filter(animal.psd, channelLocation == 'CA1') %>%
  dplyr::mutate(band_power = exp(band_power) ** log(10))
bs.ca1.fit.1 = fm2df(calc.bands.pow(subset(bs.ca1.psd, laserOn==1), freq.bands.df, c(3, 80), show.fit = TRUE)$fm, 'CA1', 1)
bs.ca1.fit.0 = fm2df(calc.bands.pow(subset(bs.ca1.psd, laserOn==0), freq.bands.df, c(3, 80), show.fit = TRUE)$fm, 'CA1', 0)

bs.ca3.psd = filter(animal.psd, channelLocation == 'CA3') %>%
  dplyr::mutate(band_power = exp(band_power) ** log(10))
bs.ca3.fit.1 = fm2df(calc.bands.pow(subset(bs.ca3.psd, laserOn==1), freq.bands.df, c(3, 80), show.fit = TRUE)$fm, 'CA3', 1)
bs.ca3.fit.0 = fm2df(calc.bands.pow(subset(bs.ca3.psd, laserOn==0), freq.bands.df, c(3, 80), show.fit = TRUE)$fm, 'CA3', 0)

bs.fit = bind_rows(bs.ca1.fit.0, bs.ca1.fit.1, bs.ca3.fit.0, bs.ca3.fit.1)
bs.fit$laserOn = as.factor(bs.fit$laserOn)
bs.fit$name = as.factor(bs.fit$name)
animal.psd$name = 'model'

bind_rows(animal.psd, bs.fit) %>%
  dplyr::mutate(name_laser=paste(name, laserOn, sep='_')) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, y=band_power, 
                group=name_laser, color=laserOn, linetype=name)) +
  geom_ribbon(aes(x=band_start_freq, y=band_power, 
                  group=name_laser, fill=laserOn,
                  ymin=band_power - sem.power, ymax=band_power + sem.power), 
              alpha=0.2) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-20, ymax=-5, alpha=0.05, fill='grey10') +
  facet_grid(. ~ channelLocation, scales = 'free') +
  scale_x_log10(limits=c(2,200), breaks=axis.breaks, labels=axis.labels) +
  scale_color_manual(values = c(nolaser.col, laser.col)) +
  scale_fill_manual(values = c(nolaser.col, laser.col)) +
  gtheme +
  theme(legend.position = 'none') +
  scale_linetype_manual(values=c('dashed', 'solid')) +
  xlab('Frequency (Hz)') + ylab('Log power (a.u.)')

ggsave(file=paste0(img_dir, '/', '5_ymaze_psd_mean.pdf'), 
       width=9, height=5.5, unit='cm', dpi=300, device=cairo_pdf)
# 
# bind_rows(animal.psd, bs.fit) %>%
# #animal.psd %>%
#   #filter(stage_desc %in% c('DuringStim')) %>%
#   filter(stage_desc %in% c('GoalZone20sec')) %>%
#   dplyr::mutate(animal_laser = paste(animal, laserOn, sep='_')) %>%
#   ggplot(aes(x=band_start_freq, y=mean.power, group=animal_laser)) +
#   geom_line(aes(color=laserOn), size=1*px2pt) +
#   geom_ribbon(aes(ymin=mean.power - sem.power, ymax=mean.power + sem.power, fill=laserOn), alpha=0.2) +
#   scale_color_manual(labels=c('OFF', 'ON'), values=c(nolaser.col, laser.col)) +
#   scale_fill_manual(labels=c('OFF', 'ON'), values=c(nolaser.col, laser.col)) +
#   facet_grid(animal ~ channelLocation) +
#   scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
#   gtheme +
#   xlab('Frequency (Hz)') + ylab('Log power')
```
Overall PSD
```{r}
all.psd = psd.molten %>%
  filter(learning_day >= 5)  %>%
  group_by(channelLocation, laserOn, stage_desc, band_start_freq) %>%
  dplyr::summarise(mean.power = mean(log(band_power)),
                   sem.power = sem(log(band_power)))

all.psd %>%
  filter(stage_desc %in% c('GoalZone20sec')) %>%
  ggplot(aes(x=band_start_freq, y=mean.power, group=laserOn)) +
  geom_line(aes(color=laserOn), size=1*px2pt) +
  geom_ribbon(aes(ymin=mean.power - sem.power, ymax=mean.power + sem.power, fill=laserOn), alpha=0.15) +
  facet_grid(. ~ channelLocation) +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  scale_color_manual(labels=c('off', 'on'), values=c(nolaser.col, laser.col)) +
  scale_fill_manual(labels=c('off', 'on'), values=c(nolaser.col, laser.col)) +
  gtheme +
  labs(fill='', color='') +
  xlab('Frequency (Hz)') + ylab('Log power')

ggsave(paste0(img_dir, '/psd_diff.pdf'), units = 'cm',
       dpi=300, device=cairo_pdf,
       height=5, width=10)
```

Plots for log(power) difference stats
```{r}
library(rlang)
compared.ymaze.psd = filter(psddf.ymaze, correct == 1, learning_day >= 5, stage_desc == 'GoalZone20sec')

calc.animal.band.summary = function(df, var) {
  var = enquo(var)
  varname = quo_name(var)
  df %>%
    dplyr::group_by(animal, channelLocation, laserOn) %>%
    dplyr::summarise(var.mean = mean(!!var),
                     var.sem = sem(!!var),
                     var = varname)
}

calc.log.diff = function(df) {
  df %>%
    dplyr::arrange(animal, channelLocation, var, laserOn) %>%
    dplyr::group_by(animal, channelLocation, var) %>%
    dplyr::summarise(diff.log.pow = diff(log(var.mean)) )
}

band.pow.summary = bind_rows(
    calc.animal.band.summary(compared.ymaze.psd, pow_ripple_band),
    calc.animal.band.summary(compared.ymaze.psd, pow_fast_gamma),
    calc.animal.band.summary(compared.ymaze.psd, pow_theta)
  ) 
band.pow.summary$var = as.factor(band.pow.summary$var)
bandnames = levels(band.pow.summary$var)

mean.band.pow.diff = calc.log.diff(band.pow.summary)
```

```{r}
mean.band.pow.diff$var = factor(mean.band.pow.diff$var, 
                                bandnames)
ggplot(mean.band.pow.diff) +
  geom_point(aes(x=var, y=diff.log.pow)) +
  geom_hline(yintercept = 0.0, linetype='dashed') +
  gtheme +
  facet_grid(. ~ channelLocation) +
  xlab('') + ylab('Log band power difference')
```
```{r}
band.pow.summary$var = as.numeric(band.pow.summary$var)

band.pow.summary %>%
  dplyr::mutate(xval = var - (as.numeric(laserOn) - 1.5),
                xgroup = paste(var, animal, sep='_')) %>% 
  ggplot(aes(x=xval, group=xgroup)) +
  geom_ribbon(aes(ymin=var.mean - var.sem, ymax=var.mean+var.sem),
                alpha=0.2) +
  geom_line(aes(y=var.mean)) +
  facet_wrap(var ~ channelLocation, scales = 'free', ncol = 6) +
  scale_x_continuous(breaks=1:length(bandnames), labels = bandnames) +
  scale_y_log10() +
  xlab('') + ylab('Log band power')
```


No change of power in ripple band.
```{r}
subset.psddf = filter(compared.ymaze.psd,
                      channelLocation == 'CA1')

m.full = lmerTest::lmer(log(pow_theta) ~ laserOn + (1 + laserOn | animal), data=subset.psddf, REML = TRUE) 
summary(m.full)
plot.model.diagnostics(m.full, subset.psddf$animal, subset.psddf$laserOn)
coef(m.full)$animal
anova(m.full, refit=FALSE, ddf='Satterthwaite')
```

# PSD fit
Fit background with FOOOF and check quality
```{r}
fit.psd.df = fit.background.df(
  filter(psd.molten,learning_day >= 5, stage_desc == 'GoalZone20sec'),
  freq.range = c(3.5, 80))

summary(fit.psd.df$fit_error)
summary(fit.psd.df$low_fit_error)
```

```{r}
g.bac.auc = plot.laser.change(fit.psd.df, background_auc) + ylab('Background spectrum AUC')
g.bac.auc
calc.laser.fixed.effects(subset(fit.psd.df, channelLocation == 'CA1'), background_auc)
calc.laser.fixed.effects(subset(fit.psd.df, channelLocation == 'CA3'), background_auc)
```


## Theta
Count of trials with theta:
```{r}
var = quo(pow_theta)
pct.theta.oscillating = group_by(fit.psd.df, channelLocation, animal, laserOn) %>%
  dplyr::summarise(pct.oscillating=sum(!is.na(!!var)) / n())
pct.theta.oscillating
ca.subset = subset(pct.theta.oscillating, channelLocation == 'CA1')
t.test(subset(ca.subset, laserOn==0)$pct.oscillating,
       subset(ca.subset, laserOn==1)$pct.oscillating, 
       paired=TRUE)
group_by(pct.theta.oscillating, channelLocation, laserOn) %>% dplyr::summarise(mean(pct.oscillating), sem(pct.oscillating))
```

Significant increase in pow theta.
```{r}
var = quo(pow_theta)
fit.theta.present = filter(fit.psd.df) %>%
  dplyr::mutate(!!var := ifelse(is.na(!!var), 0, !!var))
g.theta.pow = plot.laser.change(fit.psd.df, !!var) + ylab('Relative Theta Power (5 - 11 Hz; a.u.)')
calc.laser.fixed.effects(subset(fit.theta.present, channelLocation == 'CA1'), !!var)

var = quo(pow_slow_gamma)
fit.sgamma.present = filter(fit.psd.df) %>%
  dplyr::mutate(!!var := ifelse(is.na(!!var), 0, !!var))
g.sgamma.pow = plot.laser.change(fit.sgamma.present, !!var) + ylab('Relative Slow Gamma Power (30 - 45 Hz; a.u.)')
calc.laser.fixed.effects(subset(fit.sgamma.present, channelLocation == 'CA3'), !!var)

plot_grid(g.bac.auc, g.theta.pow, g.sgamma.pow, ncol=3)
ggsave(file=paste0(img_dir, '/', '5_psd_stats.pdf'), 
       width=12, height=5, unit='cm', dpi=300, device=cairo_pdf)
```

# Coherence
```{r}
wcoh.df = read_csv(paste(data_dir, 'ripple_coherence_table_diode.csv', sep='/'))
wcoh.df$animal = as.factor(wcoh.df$animal)
wcoh.df$laserOn = as.factor(wcoh.df$laserOn)
wcoh.df = wcoh.df %>%
  dplyr::mutate(trial_id=paste(date, animal, trial ,sep='_'))
wcoh.df$trial_id = as.factor(wcoh.df$trial_id)
wcoh.df$channelLocation = 'CA1-CA3'
```

```{r}
wcoh.molten = melt.freq.bands(wcoh.df, extra.id.vars = c('file_name'), psd.vars.prefix='all_coh_') %>%
  left_join(dplyr::select(trial.info.df, -trial, -state, -laserOn), 
            by=c('date', 'animal', 'file_name'))
```

```{r}
animal.stage.wcoh.df = wcoh.molten %>%
  filter(correct==1) %>%
  filter(learning_day>=5) %>%
  dplyr::group_by(animal, band_name, band_start_freq, laserOn, stage_desc) %>%
  dplyr::summarise(power.mean=mean(band_power, na.rm=TRUE),
                   power.sem=sem(band_power))

animal.stage.wcoh.df %>%
  filter(stage_desc == 'MazeStem') %>%
  #filter(stage_desc == 'GoalZone20sec') %>%
  dplyr::mutate(animal_laser=paste(animal, laserOn, sep='_')) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, group=animal_laser, y=power.mean, color=laserOn)) + 
  geom_ribbon(aes(x=band_start_freq, group=animal_laser, ymin=power.mean-power.sem, ymax=power.mean+power.sem),
              alpha=0.1) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-1, ymax=5, alpha=0.05, fill='grey10') +
  scale_x_log10(limits=c(1,250), breaks=axis.breaks, labels=axis.labels) +
  xlab('Frequency (Hz)') +
  ylab('Coherence') +
  facet_wrap(animal ~ ., ncol = 2) +
  gtheme +
  theme(legend.position = 'top')
```

Laser decreased coherence in the ripple band for all days, not signif
What about just the epochs of ripples in the CA3?
```{r}
subset.wcoh.df = wcoh.df %>%
  left_join(dplyr::select(trial.info.df, -trial, -state, -laserOn), 
            by=c('date', 'animal', 'file_name')) %>%
  filter(stage_desc == 'GoalZone20sec',
         correct == 1,
         learning_day >= 5)
m.full = lmerTest::lmer(log(coh_ripple_band) ~ laserOn + (1 + laserOn | animal), data=subset.wcoh.df, REML = TRUE)
m.full = lmerTest::lmer(log(coh_fast_gamma) ~ laserOn + (1 + laserOn | animal), data=subset.wcoh.df, REML = TRUE) 
summary(m.full)
plot.model.diagnostics(m.full, subset.wcoh.df$animal, subset.wcoh.df$laserOn)
coef(m.full)$animal
anova(m.full, refit=FALSE, ddf='Satterthwaite')
```
Create ratio of coherence and plot for each animal?
```{r}
wcoh.summary = wcoh.df %>%
  left_join(dplyr::select(trial.info.df, -trial, -state, -laserOn), 
          by=c('date', 'animal', 'file_name')) %>%
  filter(correct==1) %>%
  filter(learning_day>=5) %>%
  group_by(animal, laserOn) %>%
  dplyr::summarise(value.mean=mean(coh_fast_gamma),
                   value.sem=sem(coh_fast_gamma)) 

wcoh.summary %>%
  ggplot() +
  geom_errorbar(aes(x='fgamma', ymin=value.mean-value.sem, ymax=value.mean + value.sem, color=animal, group=laserOn), 
                width=0.2, position='dodge2')
```


TODO:
[] check coherence in ripple band during the epochs with ripples in CA3. 
  - need to check using the ripples generated from the right electodes.
[x] coherence of the diode signal
[x] curiosity: what is the theta phase between CA3 and CA1
  - constant for the same animal but varies between animals from 0 to 180 degrees
[x] Plot coherence in bands up to 250 Hz.
