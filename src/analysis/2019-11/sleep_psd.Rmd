---
title: "Effect of cholinergic stimulation on CA1 and CA3"
output:
  html_document:
    df_print: paged
---

TODO:
- divide analysis by channel location
- do analysis on diode
```{r include=FALSE}
knitr::opts_chunk$set(include=FALSE, collapse=TRUE, warning=FALSE, echo=FALSE)
```

Effects of the laser activation on the signal recorded in baseline conditions.

The recordings session were divided into the ones where the mouse was immobile (sleep) and mobile (awake).

Only one recording channel per animal is included for the comparisions. The channel was selected based on SNR, presence of theta oscillations when the mouse was mobile, and the number of detected ripples. The strength of the optogenetic activation could be different in each mouse, and also be different depending on the exact recording channel positions, so I showed the laser effects or each mouse separately.


```{r include=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)
library(cowplot)
library(ggpubr)
library(lmerTest)
select = dplyr::select

source('psd_analysis.R')
source('psd_fitting.R')
```

```{r}
sem = function(x) sqrt( var(x, na.rm=TRUE) / length(x))
```

```{r include=FALSE}
experiment_name = 'baseline'
diode.signal = TRUE

img_dir = paste0('/home/prez/tmp/ymaze_chat_x_ai32/img_gen/', experiment_name)
px2pt = 1/(ggplot2::.pt*72.27/96)
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=8, family = 'Arial'), 
        panel.background = element_rect(fill = 'white'),
        line = element_line(size = px2pt),
        axis.line.x = element_line(size = 0.8 * px2pt, linetype = "solid", colour = "black"),
        axis.line.y = element_line(size = 0.8 * px2pt, linetype = "solid", colour = "black"),
        axis.text.x=element_text(size=8, colour = "black"),
        axis.text.y=element_text(size=8, colour = "black"),
        axis.title.x = element_text(size=8),
        axis.title.y = element_text(size=8))

col_width = 8.5 
laser.col='#0098ffff'
nolaser.col='grey30'
```



```{r include=FALSE}
data_dir = paste0('/mnt/DATA/chat_ripples/', experiment_name)

if (diode.signal) {
  psddf = read_csv(paste0(data_dir,'/','theta_welch_psd_table_diode_th6.csv'))
} else {
  psddf = read_csv(paste0(data_dir,'/','theta_welch_psd_table_th6.csv'))
}
psddf$animal = as.factor(psddf$animal)
psddf$channel = as.factor(psddf$channel)
psddf$laserOn = as.factor(psddf$laserOn)

psddf = psddf %>%
  dplyr::mutate(trial_id=paste(date, animal, trial ,sep='_'))
psddf$trial_id = as.factor(psddf$trial_id)

#freq.bands.df = data.frame(
#  band=c('theta', 'slow gamma', 'fast gamma'),
#  xmin=c(5, 20, 80),
#  xmax=c(11, 40, 150)
#)

freq.bands.df = data.frame(
  band=c('theta', 'slow gamma', 'med gamma', 'fast gamma'),
  xmin=c(5, 30, 55, 120),
  xmax=c(11, 45, 80, 250)
)
```

# Effects on the signal spectrum
```{r}
psddf = mutate(psddf,
                    theta_over_slow = pow_theta / pow_slow,
                    theta_over_supratheta = pow_theta / pow_above_theta)
```


```{r}
psd.molten = melt.freq.bands(psddf, extra.id.vars = c('state'))
psd.ratio.df = calc.freq.band.ratio(psd.molten)

animal.psd.ratio = psd.ratio.df %>%
  dplyr::group_by(animal, band_name, band_start_freq, channelLocation, state) %>%
  dplyr::summarise(ratio.mean=mean(power.ratio.change, na.rm=TRUE),
                   ratio.sem=sem(power.ratio.change))
  
axis.breaks=c(1:9,seq(10,100,10),200)
axis.labels=rep('', length(axis.breaks))
axis.labels[1]=1
axis.labels[10]=10
axis.labels[19]=100

animal.psd.ratio %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, group=animal, y=ratio.mean, color=animal)) + 
  geom_ribbon(aes(x=band_start_freq, group=animal, ymin=ratio.mean-ratio.sem, ymax=ratio.mean+ratio.sem),
              alpha=0.1) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-1, ymax=5, alpha=0.05, fill='grey10') +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  geom_hline(yintercept=1, linetype='dashed') +
  facet_grid(state ~ channelLocation) +
  xlab('Frequency (Hz)') +
  ylab('LFP power ratio') +
  gtheme +
  theme(legend.position = 'top')
```


TODO should sample the same number of trials per animal
```{r}

channel.psd.ratio = psd.ratio.df %>%
  dplyr::group_by(band_name, band_start_freq, channelLocation, state) %>%
  dplyr::summarise(ratio.mean=mean(power.ratio.change, na.rm=TRUE),
                   ratio.sem=sem(power.ratio.change))
  
channel.psd.ratio %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, group=channelLocation, y=ratio.mean, colour=channelLocation)) + 
  geom_ribbon(aes(x=band_start_freq, group=channelLocation, ymin=ratio.mean-ratio.sem, ymax=ratio.mean+ratio.sem),
              alpha=0.1) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-1, ymax=5, alpha=0.05, fill='grey10') +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  geom_hline(yintercept=1, linetype='dashed') +
  facet_grid(state ~ channelLocation) +
  xlab('Frequency (Hz)') +
  ylab('LFP power ratio') +
  gtheme +
  theme(legend.position = 'none')
```
```{r}
animal.psd = psd.molten %>%
  filter(state != 'scopolamine') %>%
  filter(stage_desc %in% c('stim', 'before_stim')) %>%
  filter(animal == 'BS') %>%
  group_by(channelLocation, animal, laserOn, stage_desc, band_start_freq) %>%
  dplyr::summarise(sem.power = sem(log(band_power)), 
                   band_power = mean(log(band_power)))

fm2df = function(fm, channelLocation, laserOn) {
  df = bind_rows(
    data.frame(band_start_freq = fm$freqs,
               band_power = fm[['_bg_fit']],
               sem.power = 0,
               name = 'bg')
    #data.frame(band_start_freq = fm$freqs,
    #           sem.power = fm$power_spectrum,
    #           name = 'modeled'
    #)
  )
  df$channelLocation = channelLocation
  df$laserOn = laserOn
  df
}

bs.ca1.psd = filter(animal.psd, channelLocation == 'CA1') %>%
  dplyr::mutate(band_power = exp(band_power) ** log(10))
bs.ca1.fit.1 = fm2df(calc.bands.pow(subset(bs.ca1.psd, laserOn==1), freq.bands.df, show.fit = TRUE)$fm, 'CA1', 1)
bs.ca1.fit.0 = fm2df(calc.bands.pow(subset(bs.ca1.psd, laserOn==0), freq.bands.df, show.fit = TRUE)$fm, 'CA1', 0)

bs.ca3.psd = filter(animal.psd, channelLocation == 'CA3') %>%
  dplyr::mutate(band_power = exp(band_power) ** log(10))
bs.ca3.fit.1 = fm2df(calc.bands.pow(subset(bs.ca3.psd, laserOn==1), freq.bands.df, show.fit = TRUE)$fm, 'CA3', 1)
bs.ca3.fit.0 = fm2df(calc.bands.pow(subset(bs.ca3.psd, laserOn==0), freq.bands.df, show.fit = TRUE)$fm, 'CA3', 0)

bs.fit = bind_rows(bs.ca1.fit.0, bs.ca1.fit.1, bs.ca3.fit.0, bs.ca3.fit.1)
bs.fit$laserOn = as.factor(bs.fit$laserOn)
bs.fit$name = as.factor(bs.fit$name)
animal.psd$name = 'model'
bind_rows(animal.psd, bs.fit) %>%
  dplyr::mutate(name_laser=paste(name, laserOn, sep='_')) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, y=band_power, 
                group=name_laser, color=laserOn, linetype=name)) +
  geom_ribbon(aes(x=band_start_freq, y=band_power, 
                  group=name_laser, fill=laserOn,
                  ymin=band_power - sem.power, ymax=band_power + sem.power), 
              alpha=0.2) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-20, ymax=-5, alpha=0.05, fill='grey10') +
  facet_grid(. ~ channelLocation, scales = 'free') +
  scale_x_log10(limits=c(2,200), breaks=axis.breaks, labels=axis.labels) +
  scale_color_manual(values = c(nolaser.col, laser.col)) +
  scale_fill_manual(values = c(nolaser.col, laser.col)) +
  ylim(-18.5,-7.2) +
  gtheme +
  scale_linetype_manual(values=c('dashed', 'solid')) +
  xlab('Frequency (Hz)') + ylab('Log power (a.u.)')

ggsave(file=paste0(img_dir, '/', '2_psd_mean.pdf'), 
       width=13.5, height=7, unit='cm', dpi=300, device=cairo_pdf)
```


```{r}
bind_rows(animal.psd, bs.fit) %>%
  dplyr::mutate(name_laser=paste(name, laserOn, sep='_')) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, y=band_power, 
                group=name_laser, color=laserOn, linetype=name)) +
  geom_ribbon(aes(x=band_start_freq, y=band_power, 
                  group=name_laser, fill=laserOn,
                  ymin=band_power - sem.power, ymax=band_power + sem.power), 
              alpha=0.2) +
  scale_x_log10(limits=c(4,19), breaks=axis.breaks, labels=axis.labels) +
  ylim(-12,-7.3)+
  scale_color_manual(values = c(nolaser.col, laser.col)) +
  scale_fill_manual(values = c(nolaser.col, laser.col)) +
  scale_linetype_manual(values=c('dashed', 'solid')) +
  facet_grid(. ~ channelLocation, scales = 'free') +
  gtheme +
  theme(legend.position = 'none') +
  xlab('Frequency (Hz)') + ylab('Log power (a.u.)')
ggsave(file=paste0(img_dir, '/', '2_psd_fit_inset.pdf'), 
       width=8, height=8, unit='cm', dpi=300, device=cairo_pdf)
```


```{r}
trial.molten.psd = psd.molten %>%
  filter(state != 'scopolamine') %>%
  filter(animal == 'BS') %>%
  dplyr::mutate(trial_id_laser = paste(trial_id, laserOn, sep='_'))

library(permute)
sample.n.trials = function(df, n=5) {
   trial.ids = unique(df$trial_id)
   #set.seed(42)
   trial.ids = trial.ids[permute::shuffle(length(trial.ids))]
   n = min(n, length(trial.ids))
   trial.ids = trial.ids[1:n]
   filter(df, trial_id %in% trial.ids)
}

bind_rows(
  sample.n.trials(filter(trial.molten.psd, stage_desc == 'before_stim'), n=5),
  sample.n.trials(filter(trial.molten.psd, stage_desc == 'stim'), n=5)
) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, y=log(band_power), group=trial_id_laser, color=laserOn), size=0.5*px2pt) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-25, ymax=-5, alpha=0.05, fill='grey10') +
  facet_grid(animal ~ channelLocation, scales = 'free') +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  #xlim(c(3,80)) +
  scale_color_manual(values = c(nolaser.col, laser.col)) +
  gtheme +
  xlab('Frequency (Hz)') + ylab('Power (log)')

ggsave(file=paste0(img_dir, '/', '2_psd_indiv_traces.pdf'), 
       width=12.5, height=6, unit='cm', dpi=300, device=cairo_pdf)
```


```{r}
plot.model.diagnostics = function(m, animals, laser_states) {
  df = data.frame(res=unname(residuals(m)), 
                  fitted=unname(fitted(m)), 
                  animal=animals, 
                  laser=laser_states) 
  
  ggplot(df) +
    geom_point(aes(x=res, y=fitted, colour=animal, shape=laser)) +
    theme(legend.position = 'none') -> g1
  
  X=qqnorm(residuals(m), plot.it=FALSE)
  data.frame(x=X$x, y=X$y, animal=animals, laser=laser_states) %>%
    ggplot() +
    geom_point(aes(x=x, y=y, colour=animal, shape=laser)) +
    stat_qq_line(mapping=aes(sample=res), data=df) +
    xlab('Theoretical quantiles') +
    ylab('Sample quantiles') +
    theme(legend.position = 'top') -> g2
  
  plot_grid(g1,g2)
}
```


# Coherence
```{r}
#wcoh.df = read_csv(paste(data_dir, 'ripple_coherence_table_diode.csv', sep='/'))
wcoh.df = read_csv(paste(data_dir, 'coherence_table_diode.csv', sep='/'))
wcoh.df$animal = as.factor(wcoh.df$animal)
wcoh.df$laserOn = as.factor(wcoh.df$laserOn)
wcoh.df = wcoh.df %>%
  dplyr::mutate(trial_id=paste(date, animal, trial ,sep='_'))
wcoh.df$trial_id = as.factor(wcoh.df$trial_id)
wcoh.df$channelLocation = 'CA1-CA3'
```

```{r}
wcoh.molten = melt.freq.bands(wcoh.df, extra.id.vars = c(), psd.vars.prefix='all_coh_')
```

```{r}
animal.wcoh.df = wcoh.molten %>%
  dplyr::group_by(animal, band_name, band_start_freq, laserOn) %>%
  dplyr::summarise(power.mean=mean(band_power, na.rm=TRUE),
                   power.sem=sem(band_power))

animal.wcoh.df %>%
  dplyr::mutate(animal_laser=paste(animal, laserOn, sep='_')) %>%
  ggplot() +
  geom_line(aes(x=band_start_freq, group=animal_laser, y=power.mean, color=laserOn)) + 
  geom_ribbon(aes(x=band_start_freq, group=animal_laser, ymin=power.mean-power.sem, ymax=power.mean+power.sem),
              alpha=0.1) +
  geom_rect(data=freq.bands.df, mapping=aes(xmin=xmin, xmax=xmax, group=band), 
            ymin=-1, ymax=5, alpha=0.05, fill='grey10') +
  scale_x_log10(limits=c(2,250), breaks=axis.breaks, labels=axis.labels) +
  xlab('Frequency (Hz)') +
  ylab('Coherence') +
  facet_wrap(animal ~ ., ncol = 3) +
  gtheme +
  theme(legend.position = 'top')
```
Coherence not changed by the laser.
```{r}
m.full = lmerTest::lmer(log(abs(coh_theta)) ~ laserOn + (1 + laserOn | animal), data=wcoh.df, REML = TRUE) 
summary(m.full)
plot.model.diagnostics(m.full, wcoh.df$animal, wcoh.df$laserOn)
coef(m.full)$animal
anova(m.full, refit=FALSE, ddf='Satterthwaite')
```


# PSD fit
Fit background with FOOOF and check quality
```{r}
fit.psd.df = fit.background.df(psd.molten)

summary(fit.psd.df$fit_error)
summary(fit.psd.df$low_fit_error)
```


Check aperiodicity reduced on laser
```{r}
fit.psd.df %>%
  filter(stage_desc %in% c('before_stim', 'stim')) %>%
  #filter(!is.na(pow_slow_gamma)) %>%
  ggplot(aes(x=laserOn, y=background_auc)) +
  geom_jitter(width=0.2) +
  facet_grid(channelLocation ~ animal) + 
  gtheme

```
Show median change per animal
```{r}
library(rlang)
create.animal.summary = function(df, var) {
  var = enquo(var)
  group_by(df, animal, laserOn, stage_desc, channelLocation) %>% 
    dplyr::summarise(var.mean=mean(!!var, na.rm=TRUE),
                     var.sem=sem(!!var))
}

plot.laser.change = function(df, var) {
  var = enquo(var)
  summary.df = create.animal.summary(filter(df, stage_desc != 'after_stim'), !!var)
  xlabels = c('off', 'on')
  summary.df %>%
    ggplot() +
    #geom_point(aes(x=laserOn, y=var.mean, color=animal)) +
    geom_line(aes(x=laserOn, y=var.mean, group=animal)) +
    geom_ribbon(aes(x=laserOn, 
                    ymin=var.mean - var.sem, 
                    ymax=var.mean + var.sem,
                    group=animal), 
                  alpha=0.1) +
    facet_grid(. ~ channelLocation, scales = 'free') +
    xlab('Stimulation') +
    scale_x_discrete(labels=xlabels) +
    gtheme
}
```


Aperiodicity reduced:
Background offset reduced, but slope also increased -> PSD starts lower but decreases less with freq,
```{r}
calc.laser.fixed.effects = function(tested.df, var) {
  var = enquo(var)
  var.name = quo_name(var)
  form = reformulate('laserOn + (1 + laserOn | animal)', var.name)
  m.full = lmerTest::lmer(form, 
                          data=tested.df,
                          REML = TRUE) 
  print(summary(m.full))
  #print(coef(m.full)$animal)
  print(anova(m.full, refit=FALSE, ddf='Satterthwaite'))
  plot.model.diagnostics(m.full, tested.df$animal, tested.df$laserOn)
}

g.bac.auc = plot.laser.change(fit.psd.df, background_auc) + ylab('Background spectrum AUC')
g.bac.auc
calc.laser.fixed.effects(subset(fit.psd.df, channelLocation == 'CA1'), background_auc)
calc.laser.fixed.effects(subset(fit.psd.df, channelLocation == 'CA3'), background_auc)
```

## Theta
Count of trials with theta:
```{r}
var = quo(pow_theta)
pct.theta.oscillating = group_by(fit.psd.df, channelLocation, animal, laserOn) %>%
  dplyr::summarise(pct.oscillating=sum(!is.na(!!var)) / n())
pct.theta.oscillating
ca.subset = subset(pct.theta.oscillating, channelLocation == 'CA1')
t.test(subset(ca.subset, laserOn==0)$pct.oscillating,
       subset(ca.subset, laserOn==1)$pct.oscillating, 
       paired=TRUE)
group_by(pct.theta.oscillating, channelLocation, laserOn) %>% dplyr::summarise(mean(pct.oscillating), sem(pct.oscillating))
```

Significant increase in pow theta.
```{r}
fit.theta.present = filter(fit.psd.df, !is.na(!!var), channelLocation == 'CA3')
g.theta.pow = plot.laser.change(fit.psd.df, !!var) + ylab('Relative Theta Power (5 - 11 Hz; a.u.)')
g.theta.pow
calc.laser.fixed.effects(fit.theta.present, !!var)
```
Lower theta central frequency when the laser on...
```{r}
peak_var = quo(peak_theta)
filter(fit.psd.df, !is.na(!!peak_var)) %>%
  group_by(channelLocation, laserOn) %>%
  dplyr::summarise(peak_theta.mean = mean(!!peak_var),
                   peak_theta.median = median(!!peak_var),
                   peak_theta.sem = sem(!!peak_var))

plot.laser.change(fit.psd.df, !!peak_var) + ylab('Central Theta frequency (Hz)')
calc.laser.fixed.effects( filter(fit.psd.df, !is.na(!!peak_var), channelLocation == 'CA1'), !!peak_var)
```

## Slow Gamma
Significant increase in slow gamma for CA1
```{r}
var = quo(pow_med_gamma)
fit.sgamma.present = filter(fit.psd.df, !is.na(!!var), channelLocation == 'CA3')
g.sgamma.pow = plot.laser.change(fit.psd.df, !!var) + ylab('Relative Slow Gamma Power (30 - 45 Hz; a.u.)')
g.sgamma.pow
calc.laser.fixed.effects(fit.sgamma.present, !!var)
```
SGamma central frequency when the laser on...
```{r}
var = quo(peak_slow_gamma)
fit.sgamma.present %>%
  group_by(channelLocation, laserOn) %>%
  dplyr::summarise(peak_theta.mean = mean(!!var),
                   peak_theta.median = median(!!var),
                   peak_theta.sem = sem(!!var))

plot.laser.change(fit.psd.df, !!var) + ylab('Central Slow Gamma frequency (Hz)')
calc.laser.fixed.effects(fit.sgamma.present, !!var)
```

```{r}
plot_grid(g.bac.auc, g.theta.pow, g.sgamma.pow, ncol=3)
ggsave(file=paste0(img_dir, '/', '2_psd_stats.pdf'), 
       width=12, height=5, unit='cm', dpi=300, device=cairo_pdf)
```


TODO: 
[] Should check count of trials with and wo theta / sgamma. check signif with bernoulli test?
[] Run on single electrode..
[x] Plot changes for indiv animals same as for ripples
[x] Should calculate aperiodic activity as area under background
[x] Need to control for the fit of the PSD, and choose fit params based on that
