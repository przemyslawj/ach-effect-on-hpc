---
title: "Effect of cholinergic stimulation on CA3 during Y-maze task"
output:
  html_document:
    df_print: paged
---
```{r include=FALSE}
knitr::opts_chunk$set(include=FALSE, collapse=TRUE, warning=FALSE, echo=FALSE)
```

```{r }
library(readr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(PairedData)
select = dplyr::select
```

```{r}
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=16), axis.text = element_text(size=12)) 
img_dir = '~/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/'
```

```{r}
psddf = 
  read_csv('psd_table_ymaze_2018-08-17_cwt.csv') %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-15_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-16_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-18_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-19_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-20_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-21_cwt.csv')) 
  #bind_rows(read_csv('psd_table_ymaze_2018-08-22_cwt.csv')) 
psddf$animal = as.factor(psddf$animal)


psddf$experiment = as.factor(psddf$experiment)
psddf$day = as.integer(psddf$date - as.Date('2018-08-14'))
psddf$trial_id = (psddf$day - 1) * 10 + psddf$trial

animals.stim = c('K2','K3','K4','L3')
#animals.stim = c('K4')
animals.contr = c('K1', 'L1')
psddf = filter(psddf, pow_theta_Total > 0) %>%
  #filter(animal != 'K2') %>%
  mutate(laser = ifelse(animal %in% animals.stim, 'stim', ifelse(animal %in% animals.contr, 'contr', 'other'))) %>%
  filter(laser != 'other') 
psddf$laser = as.factor(psddf$laser)

#extended.results = read.csv('~/Dropbox/cam/ach/report/data/2018-02-07-ymaze_results.csv', sep = ',')
#psddf = left_join(psddf, extended.results, by = c('animal','day','trial'))
stage_levels = c('StartZone',  'FirstArm', 'Junction', 'SecondArm', 
                 'BeforeGoalZone', 'GoalZone', 'DuringStim', 'AfterReachedReward_10sec', 
                 'AfterConsumedReward_10_sec',  
                 'DuringMaze', 'HomeCageLast10sec', 'Total')
```

Signal and its spectrum from a single Y-maze trial. Red vertical lines mark different stages of the task: 1st line marking when the mouse left the start zone, the second last line marking when mouse reached the goal zone and the last line marking when it reached the reward.

1. Control mouse - K1

![K1](/home/prez/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/1_ymaze_spectrum_k1.jpg)

2. Mouse stimulated in the goal zone - K4

![K4](/home/prez/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/1_ymaze_spectrum_k4.jpg)


Figure below shows change in the  power of the signal at the reward location for specific frequency bands. Only successfull trials are included, so the laser was activated in goal zone and when the mouse was eating the reward.

```{r include=TRUE}
K1.mpsd = read.csv('all_psd_K1.csv') %>% mutate(animal = 'K1')
K2.mpsd = read.csv('all_psd_K2.csv') %>% mutate(animal = 'K2')
K3.mpsd = read.csv('all_psd_K3.csv') %>% mutate(animal = 'K3')
K4.mpsd = read.csv('all_psd_K4.csv') %>% mutate(animal = 'K4')
L1.mpsd = read.csv('all_psd_L1.csv') %>% mutate(animal = 'L1')
#L3.mpsd = read.csv('all_psd_L3.csv') %>% mutate(animal = 'L3')
mpsd = bind_rows(K1.mpsd, K2.mpsd, K3.mpsd, K4.mpsd, L1.mpsd) %>%
  mutate(goal_change = 100 * GoalZone / SecondArm - 100, 
         stim_change = 100 * DuringStim / SecondArm - 100,
         afterconsumed_change = 100 * AfterConsumedReward_10_sec / SecondArm - 100,
         afterreward_change = 100 * AfterReachedReward_10sec / SecondArm - 100) %>%
  mutate(laser = ifelse(animal %in% animals.stim, 'stim', ifelse(animal %in% animals.contr, 'contr', 'other')))

greward = ggplot(mpsd) +
  geom_line(aes(x=freqs_start, y=afterreward_change, col=animal, linetype=laser, group=animal), size=1) +
  xlab('Frequency (Hz)') +paired_group
  ylab('LFP Power Change at Reward (%)') +
  geom_hline(yintercept=1) +
  scale_x_continuous(limits=c(6,160), breaks=c(10,30,50,70,100,150)) +
  gtheme 
greward 
greward + xlim(6,40) 
#ggsave(file=paste0(img_dir, '/', 'ymaze_psd_change.svg'), greward, width=5, height=5)
```

<!-- The plots below show changes in PSD at different stages in the trial. The changes show the power in the theta, slow and fast gamma bands relative to the start of the trial. -->
<!-- For the stimulated mouse, the laser was active only during the GoalZone and AfterReachedReward_10sec stages. -->

```{r}
plot.singlevar = function(dat, variable,psd_pow=FALSE) {
  var.psddf = dat %>%
    filter(success == 1) %>%
    select(animal, laser, trial, trial_id, date, day, experiment, starts_with(variable)) %>%
    gather(stage, value, starts_with(variable)) %>%
    filter(!startsWith(stage, 'pow_theta_dom_'))
  var.psddf$stage = gsub(variable, '', var.psddf$stage)
  var.psddf$stage = factor(var.psddf$stage, stage_levels)
  plotdf = var.psddf
  if (psd_pow) {
    total.psddf = filter(var.psddf, stage == 'BeforeGoalZone') %>%
      rename(total_value=value) %>%
      right_join(var.psddf, by='experiment', suffix=c('.y','')) %>%
      filter(total_value > 0) %>%
      mutate(plotted_value = value / total_value) 
    plotdf = total.psddf
    #var.psddf$value = var.psddf$value / var.psddf[[paste0(variable,'Total')]]
  } else {
    plotdf$plotted_value = var.psddf$value
  }
  g = plotdf %>%
    filter(stage != 'Total') %>%
    dplyr::group_by(laser,stage,animal) %>%
    dplyr::summarize(mval=mean(plotted_value, na.rm=TRUE),sdval=sd(plotted_value, na.rm=TRUE)) %>%
    #filter(stage!='BeforeGoalZone' & stage!='DuringMaze' ) %>%
    filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec')) %>%
    ggplot() +
    geom_line(aes(x=stage, y=mval, group=animal, col=laser)) +
    #geom_ribbon(aes(x=stage, ymin=mval - sdval, ymax=mval + sdval, group=animal), alpha=0.1) +
    #geom_point(aes(x = stage, y = value, col = trial_id)) +
    gtheme +  xlab('stage') +
    #facet_grid(. ~ animal) + 
    theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
    ylab(variable) 
  return(g)
}

#albert.psddf = filter(psddf, animal == 'Albert' & success == 1)
#success.psddf = filter(psddf, success == 1)
#plot.singlevar(success.psddf, 'pow_slow_')
#plot.singlevar(success.psddf, 'pow_theta_', T)
plot.singlevar(psddf, 'pow_theta_', T) +
  ylab('Normalised Theta Power')  
g1=plot.singlevar(psddf, 'pow_slow_gamma_', T) +
  ylab('Normalised Slow Gamma Power')  
g1
#g2=plot.singlevar(psddf, 'pow_med_gamma_', T) +
#  ylab('Normalised Medium Gamma Power') 
#g2
plot.singlevar(psddf, 'pow_fast_gamma_', T) +
  ylab('Normalised Fast Gamma Power') 
#plot.singlevar(success.psddf, 'pow_dom_freq_')
#plot.singlevar(success.psddf, 'pow_theta_dom_freq_')
ripples_freq = plot.singlevar(psddf, 'pow_ripples_freq_') +
  ylab('Ripple Incidence (Hz)') 
#plot.singlevar(success.psddf, 'velocity_')
ripples_freq

#combined_g = plot_grid(g1, g2, labels = c("B", "C"), ncol = 2, rel_widths = c(1,1.26), label_size = 26)
#ggsave(file=paste0(img_dir, '/', 'ymaze_slow&med_gamma.svg'), combined_g, width=15, height=7)

```

```{r}
get.var.df = function(psddf, variable) {
  var.psddf = psddf %>%
    filter(success==1) %>%
    select(date,trial,animal,experiment,laser,success, starts_with(variable)) %>%
    gather(stage, value, starts_with(variable)) 
  
  var.psddf$stage = gsub(variable, '', var.psddf$stage)
  var.psddf$stage = factor(var.psddf$stage, stage_levels)
  return(var.psddf)
}

var.psddf = get.var.df(psddf, 'pow_ripples_freq_')

ripples.atstage.df = var.psddf %>%
  filter(stage=='AfterConsumedReward_10_sec')

ripples.test = kruskal.test(value~laser, data=ripples.atstage.df)
```

There are few ripples when the mice run in the goal zone and when they eat the reward. The effect of the stimulation on ripples is present in the period after the mice consumed the reward and the stimulation is not active anymore (Kruskal-Wallis test, p-value=`r ripples.test$p.value`).

```{r include=TRUE}

var.psddf %>%
  filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec', 'HomeCageLast10sec')) %>%
  ggplot() +
  geom_boxplot(aes(x=stage, y=value, col=laser)) +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
  ylim(c(0,2)) +
  ylab('Ripple incidence (Hz)')
```

Similar effect is present in fast gamma. It is lower GoalZone during stimulation and after the reward was consumed after the stimulation.

```{r include=TRUE}
var.psddf = get.var.df(psddf, 'pow_fast_gamma_')
total.psddf = filter(var.psddf, stage == 'StartZone') %>%
  rename(total_value=value) %>%
  right_join(var.psddf, by='experiment', suffix=c('.y','')) %>%
  filter(total_value > 0) %>%
  mutate(plotted_value = value / total_value) 

total.psddf %>%
  filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec', 'HomeCageLast10sec')) %>%
  ggplot() +
  geom_boxplot(aes(x=stage, y=plotted_value, col=laser)) +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
  ylim(c(0,2)) +
  ylab('Power Fast Gamma')

fgamma.atstage.df = total.psddf %>%
  filter(stage=='GoalZone')
kruskal.test(plotted_value~laser, data=fgamma.atstage.df)

fgamma.atstage.df = total.psddf %>%
  filter(stage=='AfterConsumedReward_10_sec')
kruskal.test(plotted_value~laser, data=fgamma.atstage.df)
```


Figure below shows ripple incidence in early trials vs late trials. 

```{r include=TRUE}
variable = 'pow_ripples_freq_'
var.psddf = psddf %>%
  select(animal, laser, trial, trial_id, date, day, success, experiment, starts_with(variable)) %>%
  filter(success==1) %>%
  gather(stage, value, starts_with(variable))
var.psddf$stage = gsub(variable, '', var.psddf$stage)
var.psddf$stage = factor(var.psddf$stage, stage_levels)

total.var.psddf = filter(var.psddf, stage %in% c('BeforeGoalZone', 'AfterConsumedReward_10_sec') & day > 0) 

total.var.psddf$day = as.factor(total.var.psddf$day)

g1 = ggplot(data=total.var.psddf, aes(x=day, y=value, fill=laser)) +
  geom_boxplot() +
  gtheme +  xlab('Day') +
  facet_grid(. ~ stage) +
  ylab('Ripple Incidence (Hz)') 
g1

```

TODO: show correlation with the data.

<!-- Correlation between SWRs and : start , success -->

<!-- ```{r} -->
<!-- start.var.psddf = filter(var.psddf, stage == 'StartZone') %>%  -->
<!--   select(trial_id, day, animal, laser, success, value) %>% -->
<!--   mutate(Stage='Start Zone') -->
<!-- afterreward.var.psddf = filter(var.psddf, stage == 'AfterConsumedReward_10_sec')  %>% -->
<!--   select(trial_id, day, animal, laser, success, value) %>% -->
<!--   mutate(Stage='After Reward') -->
<!-- total.var.psddf = filter(var.psddf, stage == 'Total')  %>% -->
<!--   select(trial_id, day, animal, laser, value) %>% -->
<!--   mutate(Stage='Total') -->
<!-- start_or_after.var.psddf = bind_rows(start.var.psddf, afterreward.var.psddf, total.var.psddf) %>% -->
<!--   mutate(day_success = paste(day, ' ', if_else(success==1, 'Correct', 'Incorrect')))   -->
<!-- start_or_after.var.psddf$day = as.factor(start_or_after.var.psddf$day) -->

<!-- gA = filter(start_or_after.var.psddf, animal == 'Stimulated') %>% -->
<!--   ggplot() + -->
<!--   geom_boxplot(aes(x=day_success, y=value, fill=Stage)) +albert_psdchange_at_goal_and_reward -->
<!--   gtheme + -->
<!--   theme(axis.text.x=element_text(angle = -45, hjust = 0)) + -->
<!--   ylim(0, 0.4) + -->
<!--   ylab('Ripple Incidence (Hz)') + xlab('Day') -->
<!-- gN = filter(start_or_after.var.psddf, animal == 'Control') %>% -->
<!--   ggplot() + -->
<!--   geom_boxplot(aes(x=day_success, y=value, fill=Stage)) + -->
<!--   gtheme + -->
<!--   theme(axis.text.x=element_text(angle = -45, hjust = 0)) +albert_psdchange_at_goal_and_rewardalbert_psdchange_at_goal_and_rewardalbert_psdchange_at_goal_and_reward -->
<!--   ylim(0, 0.4) + -->
<!--   ylab('Ripple Incidence (Hz)') + xlab('Day') -->

<!-- gA -->
<!-- gN -->
<!-- #combined_g = plot_grid(gA, gN, labels = c("Stimulated", "Control")) -->
<!-- #ggsave(file=paste0(img_dir, '/', 'ripple_vs_learning_freq_N&A.svg'), plot=combined_g, width=16, height=6) -->
<!-- ``` -->

<!-- Start zone over time -->
<!-- ```{r} -->

<!-- summed.start.var.psddf = start.var.psddf %>% -->
<!--   group_by(day,animal,Stage) %>% -->
<!--   summarise(mval = mean(value), sdval = sd(value), correct=mean(success)) -->

<!-- summed.afterreward.var.psddf = afterreward.var.psddf %>% -->
<!--   group_by(day,animal,Stage) %>% -->
<!--   summarise(mval = mean(value), sdval = sd(value), correct=mean(success)) -->

<!-- summed.startorafter.df = bind_rows(summed.start.var.psddf, summed.afterreward.var.psddf)  -->

<!-- # dirty trick to show day 14 -->
<!-- summed.startorafter.df$day[summed.startorafter.df$day == 14] = 8 -->

<!-- #summed.start.var.psddf$day = as.factor(summed.start.var.psddf$day) -->
<!-- days = unique(summed.start.var.psddf$day) -->
<!-- ggplot(summed.start.var.psddf) + -->
<!--   geom_line(aes(x=day, y=mval, col=animal)) + -->
<!--   gtheme + -->
<!--   #scale_x_discrete(labels=days)+ -->
<!--   ylab('Ripple Incidence at Start Zone (Hz)') + xlab('Day') -->

<!-- ggplot(summed.afterreward.var.psddf) + -->
<!--   geom_line(aes(x=day, y=mval, col=animal)) + -->
<!--   gtheme + -->
<!--   ylab('Ripple Incidence After Reward (Hz)') + xlab('Day') -->

<!-- ripples_over_time = ggplot(summed.startorafter.df) + -->
<!--   geom_line(aes(x=day, y=mval, col=Stage)) + -->
<!--   geom_ribbon(aes(x=day, ymin=mval - sdval, ymax=mval + sdval, group=Stage), alpha=0.1) + -->
<!--   facet_grid(. ~ animal) + -->
<!--   gtheme + -->
<!--   ylab('Ripple Incidence (Hz)') + xlab('Day') -->

<!-- ripples_over_time -->
<!-- #ggsave(file=paste0(img_dir, '/', 'ymaze_ripples_over_time.svg'), plot=ripples_over_time, width=10, height=5) -->
<!-- #ggsave(file=paste0(img_dir, '/', 'ymaze_ripples_freq.svg'), plot=ripples_freq, width=7, height=6) -->

<!-- ``` -->



```{r }
#Correlations of theta with speed
trials.psddf = filter(psddf)
theta_speed_cor = cor(trials.psddf$velocity_BeforeGoalZone, trials.psddf$pow_theta_BeforeGoalZone, method='pearson')

g = ggplot(trials.psddf, aes(x=velocity_BeforeGoalZone, y=log10(pow_theta_BeforeGoalZone))) +
  geom_point(aes(col=animal)) +
  geom_smooth(method = "lm", se = FALSE) + 
  annotate("text", x = 30, y=-2.5, label = paste0("r^2=", format(theta_speed_cor**2, digits=2))) +
  gtheme +
  xlab('Velocity (% / sec)') + ylab('Theta power (db / Hz)')
g
ggsave(file=".svg", plot=g, width=10, height=8)
```

<!-- Changes in frequencies as result of the laser -->

<!-- No significant difference in theta  -->
<!-- ```{r} -->
<!-- t.test(x=albert.psddf$pow_theta_SecondArm, y=albert.psddf$pow_theta_GoalZone, paired=TRUE) -->
<!-- t.test(x=nigel.psddf$pow_theta_SecondArm, y=nigel.psddf$pow_theta_GoalZone, paired=TRUE) -->
<!-- ``` -->

<!-- Difference in slow gamma  -->
<!-- ```{r} -->
<!-- t.test(x=albert.psddf$pow_slow_gamma_SecondArm, y=albert.psddf$pow_slow_gamma_GoalZone, paired=TRUE) -->
<!-- mdiff = (mean(albert.psddf$pow_slow_gamma_GoalZone) - mean(albert.psddf$pow_slow_gamma_SecondArm)) / mean(albert.psddf$pow_slow_gamma_SecondArm) -->
<!-- print(mdiff) -->
<!-- t.test(x=nigel.psddf$pow_slow_gamma_SecondArm, y=nigel.psddf$pow_slow_gamma_GoalZone, paired=TRUE) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- t.test(x=albert.psddf$pow_slow_gamma_GoalZone, y=albert.psddf$pow_slow_gamma_AfterConsumedReward_10_sec, paired=TRUE) -->
<!-- mdiff = (mean(albert.psddf$pow_slow_gamma_GoalZone) - mean(albert.psddf$pow_slow_gamma_SecondArm)) / mean(albert.psddf$pow_slow_gamma_SecondArm) -->
<!-- print(mdiff) -->
<!-- t.test(x=nigel.psddf$pow_slow_gamma_SecondArm, y=nigel.psddf$pow_slow_gamma_GoalZone, paired=TRUE) -->
<!-- ``` -->

<!-- Med gamma between -->
<!-- ```{r} -->
<!-- t.test(x=albert.psddf$pow_slow_gamma_SecondArm, y=albert.psddf$pow_slow_gamma_AfterConsumedReward_10_sec, paired=TRUE) -->
<!-- ``` -->
<!-- Stages to compare: -->
<!-- Start vs junction -->
<!-- second arm vs Goal -->
<!-- Goal vs 10sec after -->
<!-- AfterReachedReward_10sec  -->
<!-- Start vs AfterConsumedReward_10sec -->
<!-- DuringMaze vs HomeCageLast10sec -->
<!-- ```{r} -->
<!-- #test.stagechange = function(dat, fst_stage, snd_stage) {  -->
<!-- fst_stage = '_BeforeGoalZone' -->
<!-- snd_stage = '_GoalZone' -->
<!-- dat = albert.psddf -->
<!--   fst_stage_cols = colnames(dat)[endsWith(colnames(dat), fst_stage)] -->
<!--   metric_names = gsub(fst_stage, '', fst_stage_cols) -->
<!--   metric.psddf = dat %>% -->
<!--     select(animal, trial, trial_id, date, day, experiment, fst_stage_cols, ends_with(snd_stage)) -->


<!--   for (i in 1:length(metric_names)) { -->
<!--     metric_name = metric_names[i] -->
<!--     xsample = metric.psddf[[paste0(metric_name, fst_stage)]] -->
<!--     ysample = metric.psddf[[paste0(metric_name, snd_stage)]] -->
<!--     tresult = t.test(xsample, ysample, paired=TRUE) -->
<!--     if (!is.nan(tresult$p.value) & tresult$p.value < 0.01) { -->
<!--       print(paste('Varname', metric_name)) -->
<!--       print(tresult) -->

<!--       print('% difference') -->
<!--       print(tresult$estimate / mean(xsample, na.rm=TRUE)) -->
<!--     } -->

<!--   } -->

<!-- #test.stagechange(success.psddf, 'StartZone', 'Junction') -->
<!-- ``` -->



```{r}
#Diff in PSD between stage
# plot.mpsd = function(gathered.mpsd) {
#   #gathered.mpsd$power = log10(gathered.mpsd$power)
#   gathered.mpsd$stage = factor(gathered.mpsd$stage, levels=stage_levels)
#   g = gathered.mpsd %>%
#     arrange(desc(freqs_start)) %>%
#     filter(stage != 'Total' & stage!='BeforeGoalZone' & stage!='DuringMaze' & stage !='AfterConsumedReward_10_sec') %>%
#     #filter(power > -10) %>%
#     ggplot() +
#     geom_tile(aes(x=stage, y=freqs_end, fill=power)) +
#     gtheme +
#     theme(axis.text.x=element_text(angle = -45, hjust = 0), text = element_text(size=15)) +
#     ylab('Frequency (Hz)') + xlab('Stage') +
#     scale_y_log10(limits=c(3,150), breaks=c(5,10,20,40,80,150)) +
#     scale_fill_gradientn(colors = pals::parula(256)) +
#     labs(fill='Power (db/Hz)')
# }
# a1.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_albert1.csv') %>%
#   gather('stage', 'power', 1:11)
# a7.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_albert6.csv') %>%
#   gather('stage', 'power', 1:11)
# a7.gathered.mpsd$power = a7.gathered.mpsd$power - a1.gathered.mpsd$power
# gA = plot.mpsd(a7.gathered.mpsd)
# n1.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_Nigel1.csv') %>%
#   gather('stage', 'power', 1:11)
# n7.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_Nigel6.csv') %>%
#   gather('stage', 'power', 1:11)
# n7.gathered.mpsd$power = n7.gathered.mpsd$power - n1.gathered.mpsd$power
# gN = plot.mpsd(n7.gathered.mpsd)
# combined_g = plot_grid(gA, gN, labels = c("Stimulated", "Control")) +
#   ggtitle('Diff day7 - day1')
# combined_g
# ggsave(file=paste0(img_dir, '/', 'psd_changes.svg'), plot=combined_g, width=12, height=6)
 ```


