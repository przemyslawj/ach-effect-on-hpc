---
title: "Effect of cholinergic stimulation on CA3 during Y-maze task"
output:
  html_document:
    df_print: paged
---
```{r include=FALSE}
knitr::opts_chunk$set(include=FALSE, collapse=TRUE, warning=FALSE, echo=FALSE)
```

```{r }
library(readr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(PairedData)
select = dplyr::select
```

```{r}
gtheme = theme_minimal() + theme_cowplot() + 
  theme(text = element_text(size=11, family = 'Arial'), axis.text = element_text(size=11)) 
img_dir = '~/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/'
```

```{r}
sem = function(x) sqrt( var(x, na.rm=TRUE) / length(x))
```

```{r}
psddf = 
  read_csv('psd_table_ymaze_2018-08-17_cwt.csv') %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-15_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-16_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-18_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-19_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-20_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-08-21_cwt.csv')) 
  #bind_rows(read_csv('psd_table_ymaze_2018-08-22_cwt.csv')) 
psddf$animal = as.factor(psddf$animal)


psddf$experiment = as.factor(psddf$experiment)
psddf$day = as.integer(psddf$date - as.Date('2018-08-14'))
psddf$trial_id = (psddf$day - 1) * 10 + psddf$trial

animals.stim = c('K2','K3','K4','L3')
#animals.stim = c('K4')
animals.contr = c('K1', 'L1')
psddf = filter(psddf, pow_theta_Total > 0) %>%
  #filter(animal != 'K2') %>%
  mutate(laser = ifelse(animal %in% animals.stim, 'stim', ifelse(animal %in% animals.contr, 'contr', 'other'))) %>%
  filter(laser != 'other') 
psddf$laser = as.factor(psddf$laser)

#extended.results = read.csv('~/Dropbox/cam/ach/report/data/2018-02-07-ymaze_results.csv', sep = ',')
#psddf = left_join(psddf, extended.results, by = c('animal','day','trial'))
stage_levels = c('StartZone',  'FirstArm', 'Junction', 'SecondArm', 
                 'BeforeGoalZone', 'GoalZone', 'DuringStim', 'AfterReachedReward_10sec', 
                 'AfterConsumedReward_10_sec',  
                 'DuringMaze', 'HomeCageLast10sec', 'Total')
```

Signal and its spectrum from a single Y-maze trial. Red vertical lines mark different stages of the task: 1st line marking when the mouse left the start zone, the second last line marking when mouse reached the goal zone and the last line marking when it reached the reward.

1. Control mouse - K1

![K1](/home/prez/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/1_ymaze_spectrum_k1.jpg)

2. Mouse stimulated in the goal zone - K4

![K4](/home/prez/Dropbox/phd/ymaze_chat_x_ai32/img_gen/ymaze/1_ymaze_spectrum_k4.jpg)


Figure below shows change in the  power of the signal at the reward location for specific frequency bands. Only successfull trials are included, so the laser was activated in goal zone and when the mouse was eating the reward.

```{r include=TRUE}
K1.mpsd = read.csv('all_psd_K1.csv') %>% mutate(animal = 'K1')
K2.mpsd = read.csv('all_psd_K2.csv') %>% mutate(animal = 'K2')
K3.mpsd = read.csv('all_psd_K3.csv') %>% mutate(animal = 'K3')
K4.mpsd = read.csv('all_psd_K4.csv') %>% mutate(animal = 'K4')
L1.mpsd = read.csv('all_psd_L1.csv') %>% mutate(animal = 'L1')
L3.mpsd = read.csv('all_psd_L3.csv') %>% mutate(animal = 'L3')
mpsd = bind_rows(K1.mpsd, K2.mpsd, K3.mpsd, K4.mpsd, L1.mpsd, L3.mpsd) %>%
  mutate(goal_change = 100 * GoalZone / SecondArm - 100, 
         stim_change = 100 * DuringStim / SecondArm - 100,
         afterconsumed_change = 100 * AfterConsumedReward_10_sec / SecondArm - 100,
         afterreward_change = 100 * AfterReachedReward_10sec / SecondArm - 100) %>%
  mutate(laser = ifelse(animal %in% animals.stim, 'stim', ifelse(animal %in% animals.contr, 'contr', 'other')))

greward = ggplot(mpsd) +
  geom_line(aes(x=freqs_start, y=afterreward_change, col=animal, linetype=laser, group=animal), size=1) +
  xlab('Frequency (Hz)') +
  ylab('LFP Power Change at Reward (%)') +
  geom_hline(yintercept=1) +
  scale_x_continuous(limits=c(6,160), breaks=c(10,30,50,70,100,150)) +
  gtheme 
greward 
greward + xlim(6,40) 
#ggsave(file=paste0(img_dir, '/', 'ymaze_psd_change.svg'), greward, width=5, height=5)
```

<!-- The plots below show changes in PSD at different stages in the trial. The changes show the power in the theta, slow and fast gamma bands relative to the start of the trial. -->
<!-- For the stimulated mouse, the laser was active only during the GoalZone and AfterReachedReward_10sec stages. -->

```{r}
plot.singlevar = function(dat, variable,psd_pow=FALSE) {
  var.psddf = dat %>%
    filter(success == 1) %>%
    select(animal, laser, trial, trial_id, date, day, experiment, starts_with(variable)) %>%
    gather(stage, value, starts_with(variable)) %>%
    filter(!startsWith(stage, 'pow_theta_dom_'))
  var.psddf$stage = gsub(variable, '', var.psddf$stage)
  var.psddf$stage = factor(var.psddf$stage, stage_levels)
  plotdf = var.psddf
  if (psd_pow) {
    total.psddf = filter(var.psddf, stage == 'BeforeGoalZone') %>%
      rename(total_value=value) %>%
      right_join(var.psddf, by='experiment', suffix=c('.y','')) %>%
      filter(total_value > 0) %>%
      mutate(plotted_value = value / total_value) 
    plotdf = total.psddf
    #var.psddf$value = var.psddf$value / var.psddf[[paste0(variable,'Total')]]
  } else {
    plotdf$plotted_value = var.psddf$value
  }
  g = plotdf %>%
    filter(stage != 'Total') %>%
    dplyr::group_by(laser,stage,animal) %>%
    dplyr::summarize(mval=mean(plotted_value, na.rm=TRUE),sdval=sd(plotted_value, na.rm=TRUE)) %>%
    #filter(stage!='BeforeGoalZone' & stage!='DuringMaze' ) %>%
    filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'DuringStim', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec', 'HomeCageLast10sec')) %>%
    ggplot() +
    geom_line(aes(x=stage, y=mval, group=animal, col=laser)) +
    #geom_ribbon(aes(x=stage, ymin=mval - sdval, ymax=mval + sdval, group=animal), alpha=0.1) +
    #geom_point(aes(x = stage, y = value, col = trial_id)) +
    gtheme +  xlab('stage') +
    #facet_grid(. ~ animal) + 
    theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
    ylab(variable) 
  return(g)
}

#albert.psddf = filter(psddf, animal == 'Albert' & success == 1)
#success.psddf = filter(psddf, success == 1)
#plot.singlevar(success.psddf, 'pow_slow_')
#plot.singlevar(success.psddf, 'pow_theta_', T)
plot.singlevar(psddf, 'pow_theta_', T) +
  ylab('Normalised Theta Power')  
g1=plot.singlevar(psddf, 'pow_slow_gamma_', T) +
  ylab('Normalised Slow Gamma Power')  
g1
#g2=plot.singlevar(psddf, 'pow_med_gamma_', T) +
#  ylab('Normalised Medium Gamma Power') 
#g2
plot.singlevar(psddf, 'pow_fast_gamma_', T) +
  ylab('Normalised Fast Gamma Power') 
#plot.singlevar(success.psddf, 'pow_dom_freq_')
#plot.singlevar(success.psddf, 'pow_theta_dom_freq_')
ripples_freq = plot.singlevar(psddf, 'pow_ripples_freq_') +
  ylab('Ripple Incidence (Hz)') 
#plot.singlevar(success.psddf, 'velocity_')
ripples_freq

#combined_g = plot_grid(g1, g2, labels = c("B", "C"), ncol = 2, rel_widths = c(1,1.26), label_size = 26)
#ggsave(file=paste0(img_dir, '/', 'ymaze_slow&med_gamma.svg'), combined_g, width=15, height=7)

```

```{r}
get.var.df = function(psddf, variable) {
  var.psddf = psddf %>%
    filter(success==1) %>%
    select(date,trial,animal,experiment,laser,success, starts_with(variable)) %>%
    gather(stage, value, starts_with(variable)) 
  
  var.psddf$stage = gsub(variable, '', var.psddf$stage)
  var.psddf$stage = factor(var.psddf$stage, stage_levels)
  return(var.psddf)
}

var.psddf = get.var.df(psddf, 'pow_ripples_freq_')

ripples.atstage.df = var.psddf %>%
  filter(stage=='AfterConsumedReward_10_sec')

ripples.test = kruskal.test(value~laser, data=ripples.atstage.df)
```

There are few ripples when the mice run in the goal zone and when they eat the reward. The effect of the stimulation on ripples is present in the period after the mice consumed the reward and the stimulation is not active anymore (Kruskal-Wallis test, p-value=`r ripples.test$p.value`).

```{r include=TRUE}

var.psddf %>%
  filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'DuringStim', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec', 'HomeCageLast10sec')) %>%
  ggplot() +
  geom_boxplot(aes(x=stage, y=value, col=laser)) +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
  ylim(c(0,2)) +
  ylab('Ripple incidence (Hz)')
```

Similar effect is present in fast gamma. It is lower GoalZone during stimulation and after the reward was consumed after the stimulation.

```{r include=TRUE}
var.psddf = get.var.df(psddf, 'pow_fast_gamma_')
total.psddf = filter(var.psddf, stage == 'StartZone') %>%
  rename(total_value=value) %>%
  right_join(var.psddf, by='experiment', suffix=c('.y','')) %>%
  filter(total_value > 0) %>%
  mutate(plotted_value = value / total_value) 

total.psddf %>%
  filter(stage %in% c('BeforeGoalZone', 'GoalZone', 'AfterReachedReward_10sec', 'AfterConsumedReward_10_sec', 'HomeCageLast10sec')) %>%
  ggplot() +
  geom_boxplot(aes(x=stage, y=plotted_value, col=laser)) +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
  ylim(c(0,2)) +
  ylab('Power Fast Gamma')

fgamma.atstage.df = total.psddf %>%
  filter(stage=='GoalZone')
kruskal.test(plotted_value~laser, data=fgamma.atstage.df)

fgamma.atstage.df = total.psddf %>%
  filter(stage=='AfterConsumedReward_10_sec')
kruskal.test(plotted_value~laser, data=fgamma.atstage.df)
```


Figure below shows ripple incidence in early trials vs late trials. 

```{r include=TRUE}
variable = 'pow_ripples_freq_'
var.psddf = psddf %>%
  select(animal, laser, trial, trial_id, date, day, success, experiment, starts_with(variable)) %>%
  #filter(success==1) %>%
  gather(stage, value, starts_with(variable))
var.psddf$stage = gsub(variable, '', var.psddf$stage)
var.psddf$stage = factor(var.psddf$stage, stage_levels)

total.var.psddf = filter(var.psddf, stage %in% c('BeforeGoalZone', 'AfterConsumedReward_10_sec') & day > 0) 

total.var.psddf$day = as.factor(total.var.psddf$day)
summary.var.psddf = total.var.psddf %>%
  group_by(day, laser, stage) %>%
  summarise(mincidence = mean(value),
          semincidence=sem(value))

g1 = ggplot(data=summary.var.psddf, aes(x=day,y=mincidence, colour=laser)) +
  #geom_boxplot() +
  geom_bar(
    position=position_dodge(), stat='identity', fill='white') +
  geom_errorbar(aes(ymin=mincidence-semincidence,
                    ymax=mincidence+semincidence),
                position=position_dodge(.9), width=0.2) +
  #geom_jitter(data=total.var.psddf, aes(x=day,y=value,shape=laser, colour=laser), position = position_dodge(0.9)) +
  gtheme +  xlab('Day') +
  facet_grid(. ~ stage) +
  ylab('Ripple Incidence (Hz)') +
  theme(legend.position = 'top') +
  scale_colour_manual(values = c("grey", "#4050abff")) +
  ylim(c(0,1.5))
g1
ggsave(file=paste0(img_dir, '/', '5_ripples_over_time.svg'), g1, width=23, height=12, units='cm')

g2 = ggplot(data=total.var.psddf, aes(x=day,y=value, colour=laser)) +
  geom_boxplot() +
  gtheme +  xlab('Day') +
  facet_grid(. ~ stage) +
  ylab('Ripple Incidence (Hz)') +
  theme(legend.position = 'top') +
  ylim(c(0,1.5))
g2
ggsave(file=paste0(img_dir, '/', '5_ripples_over_time2.svg'), g2, width=23, height=12, units='cm')
```

Correlation between success and ripples
```{r}
library(reshape2)
behav.data.dir = '/home/prez/Dropbox/phd/ymaze_chat_x_ai32/data/'
behav.df.contr = read.csv(paste0(behav.data.dir, 'ymaze_success_nostim.csv')) %>%
  melt('Day', variable.name='animal', value.name='correct') %>%
  mutate(laser='contr')
behav.df.laser = read.csv(paste0(behav.data.dir, 'ymaze_success_rewardstim.csv')) %>%
  melt('Day', variable.name='animal', value.name='correct') %>%
  mutate(laser='stim')
behav.df = bind_rows(behav.df.contr, behav.df.laser) %>%
  rename(day=Day)
behav.df$day = as.factor(behav.df$day)

behav.df.summary = behav.df %>%
  group_by(day, laser) %>%
  summarise(mcorrect=mean(correct)) 

total.var.psddf %>% 
  filter(success==1, stage=='AfterConsumedReward_10_sec') %>%
  group_by(day, laser) %>%
  summarise(mincidence=mean(value)) %>%
  left_join(behav.df.summary) -> ripple.corr.df


ripple.corr = cor(ripple.corr.df$mcorrect, ripple.corr.df$mincidence, method='pearson')
ggplot(ripple.corr.df, aes(x=mincidence, y=mcorrect)) +
  geom_point(aes(colour=laser),size=1) +
  geom_smooth(method = "lm", se = FALSE) + 
  annotate("text", x = 0.2, y=76, label = paste0("r^2=", format(ripple.corr**2, digits=2))) +
  gtheme +
  theme(legend.position = 'top') +
  xlab('Mean Daily Ripple Incidence (Hz)') +
  ylab('Correct %')
ggsave(file=paste0(img_dir, '/', '5_mincidence_correlation.svg'), width=11, height=8, units='cm')
```

The model should be ok: no high residuals with big levarage, residuals semi-normally distributed
```{r}
lm.correct = aov(lm(mcorrect ~ mincidence, ripple.corr.df))
summary(lm.correct)
plot(lm.correct)
```


```{r}
total.var.psddf$day = as.integer(total.var.psddf$day)
total.var.psddf %>%
  filter(stage == 'AfterConsumedReward_10_sec', day < 8) %>%
  group_by(day, animal, laser) %>%
  summarise(mcorrect=sum(success)/n(), mincidence=mean(value)) ->a
  ggplot(a) +
  geom_point(aes(x=mincidence, y=mcorrect, colour=laser, size=day), alpha=0.5) +
  xlab('Mean Ripple Incidence (Hz)') +
  ylab('Correct %')
```

All ripples incidence
```{r}
ripples.df = read_csv('all_ripples.csv.bac')  %>%
  mutate(laser = ifelse(animal %in% animals.stim, 'stim', ifelse(animal %in% animals.contr, 'contr', 'other')),
         trial_id = paste(date, animal, trial, sep='_'))
ripples.df$day = as.integer(ripples.df$date - as.Date('2018-08-14'))
ripples.df$laser = as.factor(ripples.df$laser)
```

```{r}
ripples.df %>%
  group_by(laser, day, trial) %>%
  summarise(maxpeak=max(peak_t)) %>%
  filter(maxpeak>10) %>%
  ggplot(aes(x=day, fill=laser)) +
  geom_histogram()
```


```{r}
source('../bin_ripples.R')

bin.dur = 5
ripples.df.days = filter(ripples.df, day > 0, day < 6)
time.min = min(ripples.df.days$peak_t)
time.max = max(ripples.df.days$peak_t)

binned.ripple.df.contr = filter(ripples.df.days, laser == 'contr', animal=='K1') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='contr', animal='K1')
binned.ripple.df.contr2 = filter(ripples.df.days, laser == 'contr', animal=='L1') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='contr', animal='L1')
binned.ripple.df.stim = filter(ripples.df.days, laser == 'stim', animal == 'K4') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='stim', animal='K4')
binned.ripple.df.stim2 = filter(ripples.df.days, laser == 'stim', animal == 'K2') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='stim', animal='K2')
binned.ripple.df.stim3 = filter(ripples.df.days, laser == 'stim', animal == 'K3') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='stim', animal='K3')
binned.ripple.df.stim4 = filter(ripples.df.days, laser == 'stim', animal == 'L3') %>% 
  bin.ripples(time.min, time.max, bin_dur=bin.dur) %>%
  mutate(laser='stim', animal='L3')
binned.ripple.df = bind_rows(binned.ripple.df.contr, binned.ripple.df.stim,
                             binned.ripple.df.contr2, binned.ripple.df.stim2, binned.ripple.df.stim3, binned.ripple.df.stim4)

incidence.summary = binned.ripple.df %>%
  group_by(bin_sec, animal, laser) %>%
  summarise(mincidence = mean(incidence, na.rm = TRUE),
            incidence.sd = sem(incidence))


g = ggplot(incidence.summary, aes(x=bin_sec, y=mincidence, colour=laser)) +
  #geom_col(fill='gray', colour='black') +
  #geom_col(aes(fill=laser), colour='black', alpha=0.5) +
  #geom_errorbar(aes(ymin=mincidence - incidence.sd, ymax=mincidence +incidence.sd)) +
  geom_bar(
    position=position_dodge(), stat='identity', fill='white') +
  geom_errorbar(aes(ymin=mincidence-incidence.sd,
                    ymax=mincidence+incidence.sd),
                position=position_dodge(bin.dur), width=0.2) +
  
  ylab('Ripple\nincidence (Hz)') +
  xlab('Time (sec)') +
  xlim(c(-13,33)) +
  facet_grid(animal ~ .) +
  #scale_fill_manual(values = c("grey", "#56B4E9")) +
  gtheme
  #theme(legend.position = 'none') 

g
```


```{r }
#Correlations of theta with speed
trials.psddf = filter(psddf)
theta_speed_cor = cor(trials.psddf$velocity_BeforeGoalZone, trials.psddf$pow_theta_BeforeGoalZone, method='pearson')

g = ggplot(trials.psddf, aes(x=velocity_BeforeGoalZone, y=log10(pow_theta_BeforeGoalZone))) +
  geom_point(aes(col=animal)) +
  geom_smooth(method = "lm", se = FALSE) + 
  annotate("text", x = 30, y=-2.5, label = paste0("r^2=", format(theta_speed_cor**2, digits=2))) +
  gtheme +
  xlab('Velocity (% / sec)') + ylab('Theta power (db / Hz)')
g
ggsave(file=".svg", plot=g, width=10, height=8)
```
