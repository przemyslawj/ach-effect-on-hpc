-psd_table_rest_cwt2--
title: "PSD ymaze analysis"
output: html_notebook
---

```{r }
library(readr)
library(dplyr)
library(ggplot2)
library(cowplot)
library(tidyr)
library(PairedData)
select = dplyr::select
```

GGplot theme
```{r}
gtheme = theme() + theme_minimal() + theme(text = element_text(size=15)) 
img_dir = '~/Dropbox/cam/ach/report/img/'
```

```{r}
psddf = 
  read_csv('psd_table_ymaze_2018-02-07_cwt.csv') %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-08_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-09_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-10_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-11_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-12_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-13_cwt.csv')) %>%
  bind_rows(read_csv('psd_table_ymaze_2018-02-20_cwt.csv')) 
psddf$animal = as.factor(psddf$animal)


psddf$experiment = as.factor(psddf$experiment)
psddf$day = as.integer(psddf$date - as.Date('2018-02-06'))
psddf$trial_id = (psddf$day - 1) * 10 + psddf$trial

psddf = filter(psddf, pow_theta_Total > 0)
extended.results = read.csv('~/Dropbox/cam/ach/report/data/2018-02-07-ymaze_results.csv', sep = ',')
psddf = left_join(psddf, extended.results, by = c('animal','day','trial'))
levels(psddf$animal)[levels(psddf$animal) == 'Albert'] = 'Stimulated'
levels(psddf$animal)[levels(psddf$animal) == 'Nigel'] = 'Control'
stage_levels = c('StartZone',  'FirstArm',
                 'Junction', 'SecondArm', 'BeforeGoalZone',
                 'GoalZone', 'AfterReachedReward_10sec', 
                 'AfterConsumedReward_10_sec',  
                 'DuringMaze', 'HomeCageLast10sec', 'Total')
```


PSD change at reward
```{r}
albert.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/albert_all_psd.csv') %>%
  mutate(animal = 'Stimulated',
         goal_change = 100 * GoalZone / SecondArm - 100,
         afterreward_change = AfterReachedReward_10sec / SecondArm)
nigel.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/nigel_all_psd.csv') %>%
  mutate(animal = 'Control',
         goal_change = 100 * GoalZone / SecondArm - 100, 
         afterreward_change = AfterReachedReward_10sec / SecondArm)
mpsd = bind_rows(nigel.mpsd, albert.mpsd)
mpsd$animal = factor(mpsd$animal, levels=c('Stimulated','Control'))

greward = ggplot(mpsd) +
  geom_line(aes(x=freqs_start, y=goal_change, col=animal)) +
  xlab('Frequency (Hz)') +
  ylab('LFP Power Change at Reward (%)') +
  xlim(6,180) + 
  gtheme + theme(legend.position = 'none') 
greward
ggsave(file=paste0(img_dir, '/', 'ymaze_psd_change.svg'), greward, width=5, height=5)
```

```{r}
plot.singlevar = function(dat, variable,psd_pow=FALSE) {
  var.psddf = dat %>%
    select(animal, trial, trial_id, date, day, experiment, starts_with(variable)) %>%
    gather(stage, value, starts_with(variable))
  var.psddf$stage = gsub(variable, '', var.psddf$stage)
  var.psddf$stage = factor(var.psddf$stage, stage_levels)
  plotdf = var.psddf
  if (psd_pow) {
    total.psddf = filter(var.psddf, stage == 'StartZone') %>%
      rename(total_value=value) %>%
      right_join(var.psddf, by='experiment', suffix=c('.y','')) %>%
      mutate(plotted_value = value / total_value) 
    plotdf = total.psddf
    #var.psddf$value = var.psddf$value / var.psddf[[paste0(variable,'Total')]]
  } else {
    plotdf$plotted_value = var.psddf$value
  }
  g = plotdf %>%
    filter(stage != 'Total') %>%
    dplyr::group_by(animal,stage) %>%
    dplyr::summarize(mval=mean(plotted_value),sdval=sd(plotted_value)) %>%
    filter(stage!='BeforeGoalZone' & stage!='DuringMaze' ) %>%
    ggplot() +
    geom_line(aes(x=stage, y=mval, group=animal, col=animal)) +
    geom_ribbon(aes(x=stage, ymin=mval - sdval, ymax=mval + sdval, group=animal, fill=animal), alpha=0.1) +
    #geom_point(aes(x = stage, y = value, col = trial_id)) +
    #geom_line(aes(x=stage,y=value,group=experiment, col=trial_id)) +
    gtheme +  xlab('Stage') +
    theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
    ylab(variable) 
  return(g)
}

#albert.psddf = filter(psddf, animal == 'Albert' & success == 1)
#success.psddf = filter(psddf, success == 1)
#plot.singlevar(success.psddf, 'pow_slow_')
#plot.singlevar(success.psddf, 'pow_theta_', T)
plot.singlevar(psddf, 'pow_above_theta_', T) +
  ylab('Normalised Above Theta Power') + 
  theme(legend.position = 'none')
g1=plot.singlevar(psddf, 'pow_slow_gamma_', T) +
  ylab('Normalised Slow Gamma Power') + 
  theme(legend.position = 'none')
g1
g2=plot.singlevar(psddf, 'pow_med_gamma_', T) +
  ylab('Normalised Medium Gamma Power') 
g2
plot.singlevar(success.psddf, 'pow_fast_gamma_', T) +
  ylab('Normalised Fast Gamma Power') 
#plot.singlevar(success.psddf, 'pow_dom_freq_')
#plot.singlevar(success.psddf, 'pow_theta_dom_freq_')
ripples_freq = plot.singlevar(psddf, 'pow_ripples_freq_') +
  ylab('Ripple Incidence (Hz)') 
#plot.singlevar(success.psddf, 'velocity_')
ripples_freq

combined_g = plot_grid(g1, g2, labels = c("B", "C"), ncol = 2, rel_widths = c(1,1.26), label_size = 26)
ggsave(file=paste0(img_dir, '/', 'ymaze_slow&med_gamma.svg'), combined_g, width=15, height=7)

```
Statistical difference in slow & med gamma
```{r}
stim.vars = psddf %>%
  filter(animal == 'Stimulated') 
control.vars = psddf %>%
  filter(animal == 'Control') 
t.test(stim.vars$pow_slow_gamma_GoalZone / stim.vars$pow_slow_gamma_StartZone, 
       control.vars$pow_slow_gamma_GoalZone / control.vars$pow_slow_gamma_StartZone)
t.test(stim.vars$pow_slow_gamma_AfterReachedReward_10sec / stim.vars$pow_slow_gamma_StartZone, 
       control.vars$pow_slow_gamma_AfterReachedReward_10sec / control.vars$pow_slow_gamma_StartZone)
t.test(stim.vars$pow_slow_gamma_AfterConsumedReward_10_sec / stim.vars$pow_slow_gamma_StartZone, 
       control.vars$pow_slow_gamma_AfterConsumedReward_10_sec / control.vars$pow_slow_gamma_StartZone)
t.test(stim.vars$pow_slow_gamma_HomeCageLast10sec / stim.vars$pow_slow_gamma_StartZone, 
       control.vars$pow_slow_gamma_HomeCageLast10sec / control.vars$pow_slow_gamma_StartZone)
# Med gamma
t.test(stim.vars$pow_med_gamma_AfterConsumedReward_10_sec / stim.vars$pow_slow_gamma_StartZone, 
       control.vars$pow_med_gamma_AfterConsumedReward_10_sec / control.vars$pow_slow_gamma_StartZone)
```

Ripples in early trials vs late trials
```{r}
variable = 'pow_ripples_freq_'
var.psddf = psddf %>%
  select(animal, trial, trial_id, date, day, experiment, success, starts_with(variable)) %>%
  gather(stage, value, starts_with(variable))
var.psddf$stage = gsub(variable, '', var.psddf$stage)
var.psddf$stage = factor(var.psddf$stage, stage_levels)

total.var.psddf = filter(var.psddf, stage == 'Total' & day > 0) 
albert.total.var.psddf = filter(total.var.psddf, animal == 'Stimulated')
nigel.total.var.psddf = filter(total.var.psddf, animal == 'Control')
t.test(albert.total.var.psddf$value, nigel.total.var.psddf$value)

total.var.psddf$day = as.factor(total.var.psddf$day)

g1 = ggplot(data=total.var.psddf, aes(x=day, y=value, fill=animal)) +
  geom_boxplot() +
  gtheme +  xlab('Day') +
  ylab('Ripple Incidence (Hz)') 
g1

```
Correlation between SWRs and : start , success

```{r}
start.var.psddf = filter(var.psddf, stage == 'StartZone') %>% 
  select(trial_id, day, animal, success, value) %>%
  mutate(Stage='Start Zone')
afterreward.var.psddf = filter(var.psddf, stage == 'AfterConsumedReward_10_sec')  %>%
  select(trial_id, day, animal, success, value) %>%
  mutate(Stage='After Reward')
total.var.psddf = filter(var.psddf, stage == 'Total')  %>%
  select(trial_id, day, animal, success, value) %>%
  mutate(Stage='Total')
start_or_after.var.psddf = bind_rows(start.var.psddf, afterreward.var.psddf, total.var.psddf) %>%
  mutate(day_success = paste(day, ' ', if_else(success==1, 'Correct', 'Incorrect')))  
start_or_after.var.psddf$day = as.factor(start_or_after.var.psddf$day)

gA = filter(start_or_after.var.psddf, animal == 'Stimulated') %>%
  ggplot() +
  geom_boxplot(aes(x=day_success, y=value, fill=Stage)) +albert_psdchange_at_goal_and_reward
  gtheme +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +
  ylim(0, 0.4) +
  ylab('Ripple Incidence (Hz)') + xlab('Day')
gN = filter(start_or_after.var.psddf, animal == 'Control') %>%
  ggplot() +
  geom_boxplot(aes(x=day_success, y=value, fill=Stage)) +
  gtheme +
  theme(axis.text.x=element_text(angle = -45, hjust = 0)) +albert_psdchange_at_goal_and_rewardalbert_psdchange_at_goal_and_rewardalbert_psdchange_at_goal_and_reward
  ylim(0, 0.4) +
  ylab('Ripple Incidence (Hz)') + xlab('Day')

gA
gN
#combined_g = plot_grid(gA, gN, labels = c("Stimulated", "Control"))
#ggsave(file=paste0(img_dir, '/', 'ripple_vs_learning_freq_N&A.svg'), plot=combined_g, width=16, height=6)
```

Start zone over time
```{r}

summed.start.var.psddf = start.var.psddf %>%
  group_by(day,animal,Stage) %>%
  summarise(mval = mean(value), sdval = sd(value), correct=mean(success))

summed.afterreward.var.psddf = afterreward.var.psddf %>%
  group_by(day,animal,Stage) %>%
  summarise(mval = mean(value), sdval = sd(value), correct=mean(success))

summed.startorafter.df = bind_rows(summed.start.var.psddf, summed.afterreward.var.psddf) 

# dirty trick to show day 14
summed.startorafter.df$day[summed.startorafter.df$day == 14] = 8

#summed.start.var.psddf$day = as.factor(summed.start.var.psddf$day)
days = unique(summed.start.var.psddf$day)
ggplot(summed.start.var.psddf) +
  geom_line(aes(x=day, y=mval, col=animal)) +
  gtheme +
  #scale_x_discrete(labels=days)+
  ylab('Ripple Incidence at Start Zone (Hz)') + xlab('Day')

ggplot(summed.afterreward.var.psddf) +
  geom_line(aes(x=day, y=mval, col=animal)) +
  gtheme +
  ylab('Ripple Incidence After Reward (Hz)') + xlab('Day')

ripples_over_time = ggplot(summed.startorafter.df) +
  geom_line(aes(x=day, y=mval, col=Stage)) +
  geom_ribbon(aes(x=day, ymin=mval - sdval, ymax=mval + sdval, group=Stage), alpha=0.1) +
  facet_grid(. ~ animal) +
  gtheme +
  ylab('Ripple Incidence (Hz)') + xlab('Day')

ripples_over_time
ggsave(file=paste0(img_dir, '/', 'ymaze_ripples_over_time.svg'), plot=ripples_over_time, width=10, height=5)
ggsave(file=paste0(img_dir, '/', 'ymaze_ripples_freq.svg'), plot=ripples_freq, width=7, height=6)

```


Questions:
Correlations of theta with speed
```{r}
trials.psddf = filter(psddf)
theta_speed_cor = cor(trials.psddf$velocity_BeforeGoalZone, trials.psddf$pow_theta_BeforeGoalZone, method='pearson')

ggplot(trials.psddf, aes(x=velocity_BeforeGoalZone, y=log10(pow_theta_BeforeGoalZone))) +
  geom_point(aes(col=animal)) +
  geom_smooth(method = "lm", se = FALSE) + 
  annotate("text", x = 30, y=-2.5, label = paste0("r=", format(theta_speed_cor, digits=2))) +
  gtheme +
  xlab('Velocity (% / sec)') + ylab('Theta power (db / Hz)')
ggsave(file=".svg", plot=g, width=10, height=8)
```
```{r}
trials.psddf = filter(psddf)
theta_speed_cor = cor(trials.psddf$velocity_SecondArm, trials.psddf$pow_theta_dom_freq_SecondArm, method='pearson')

t.test(albert.psddf$pow_theta_BeforeGoalZone, albert.psddf$pow_theta_GoalZone, paired=TRUE)
```

Changes in frequencies as result of the laser

No significant difference in theta 
```{r}
t.test(x=albert.psddf$pow_theta_SecondArm, y=albert.psddf$pow_theta_GoalZone, paired=TRUE)
t.test(x=nigel.psddf$pow_theta_SecondArm, y=nigel.psddf$pow_theta_GoalZone, paired=TRUE)
```

Difference in slow gamma 
```{r}
t.test(x=albert.psddf$pow_slow_gamma_SecondArm, y=albert.psddf$pow_slow_gamma_GoalZone, paired=TRUE)
mdiff = (mean(albert.psddf$pow_slow_gamma_GoalZone) - mean(albert.psddf$pow_slow_gamma_SecondArm)) / mean(albert.psddf$pow_slow_gamma_SecondArm)
print(mdiff)
t.test(x=nigel.psddf$pow_slow_gamma_SecondArm, y=nigel.psddf$pow_slow_gamma_GoalZone, paired=TRUE)
```

```{r}
t.test(x=albert.psddf$pow_slow_gamma_GoalZone, y=albert.psddf$pow_slow_gamma_AfterConsumedReward_10_sec, paired=TRUE)
mdiff = (mean(albert.psddf$pow_slow_gamma_GoalZone) - mean(albert.psddf$pow_slow_gamma_SecondArm)) / mean(albert.psddf$pow_slow_gamma_SecondArm)
print(mdiff)
t.test(x=nigel.psddf$pow_slow_gamma_SecondArm, y=nigel.psddf$pow_slow_gamma_GoalZone, paired=TRUE)
```

Med gamma between
```{r}
t.test(x=albert.psddf$pow_slow_gamma_SecondArm, y=albert.psddf$pow_slow_gamma_AfterConsumedReward_10_sec, paired=TRUE)
```
Stages to compare:
Start vs junction
second arm vs Goal
Goal vs 10sec after
AfterReachedReward_10sec 
Start vs AfterConsumedReward_10sec
DuringMaze vs HomeCageLast10sec
```{r}
#test.stagechange = function(dat, fst_stage, snd_stage) { 
fst_stage = '_BeforeGoalZone'
snd_stage = '_GoalZone'
dat = albert.psddf
  fst_stage_cols = colnames(dat)[endsWith(colnames(dat), fst_stage)]
  metric_names = gsub(fst_stage, '', fst_stage_cols)
  metric.psddf = dat %>%
    select(animal, trial, trial_id, date, day, experiment, fst_stage_cols, ends_with(snd_stage))
  
  
  for (i in 1:length(metric_names)) {
    metric_name = metric_names[i]
    xsample = metric.psddf[[paste0(metric_name, fst_stage)]]
    ysample = metric.psddf[[paste0(metric_name, snd_stage)]]
    tresult = t.test(xsample, ysample, paired=TRUE)
    if (!is.nan(tresult$p.value) & tresult$p.value < 0.01) {
      print(paste('Varname', metric_name))
      print(tresult)
      
      print('% difference')
      print(tresult$estimate / mean(xsample, na.rm=TRUE))
    }
    
  }

#test.stagechange(success.psddf, 'StartZone', 'Junction')
```


Diff in PSD between stages

```{r}
plot.mpsd = function(gathered.mpsd) {
  #gathered.mpsd$power = log10(gathered.mpsd$power)
  gathered.mpsd$stage = factor(gathered.mpsd$stage, levels=stage_levels)
  g = gathered.mpsd %>%
    arrange(desc(freqs_start)) %>%
    filter(stage != 'Total' & stage!='BeforeGoalZone' & stage!='DuringMaze' & stage !='AfterConsumedReward_10_sec') %>%
    #filter(power > -10) %>%
    ggplot() +
    geom_tile(aes(x=stage, y=freqs_end, fill=power)) +
    gtheme +
    theme(axis.text.x=element_text(angle = -45, hjust = 0), text = element_text(size=15)) +
    ylab('Frequency (Hz)') + xlab('Stage') +
    scale_y_log10(limits=c(3,150), breaks=c(5,10,20,40,80,150)) +
    scale_fill_gradientn(colors = pals::parula(256)) +
    labs(fill='Power (db/Hz)')
}
a1.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_albert1.csv') %>%
  gather('stage', 'power', 1:11) 
a7.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_albert6.csv') %>%
  gather('stage', 'power', 1:11) 
a7.gathered.mpsd$power = a7.gathered.mpsd$power - a1.gathered.mpsd$power 
gA = plot.mpsd(a7.gathered.mpsd)
n1.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_Nigel1.csv') %>%
  gather('stage', 'power', 1:11) 
n7.gathered.mpsd = read.csv('~/Dropbox/cam/ach/report/data/daily_ymaze_psd/wide_psd_Nigel6.csv') %>%
  gather('stage', 'power', 1:11) 
n7.gathered.mpsd$power = n7.gathered.mpsd$power - n1.gathered.mpsd$power 
gN = plot.mpsd(n7.gathered.mpsd)
combined_g = plot_grid(gA, gN, labels = c("Stimulated", "Control")) +
  ggtitle('Diff day7 - day1')
combined_g
ggsave(file=paste0(img_dir, '/', 'psd_changes.svg'), plot=combined_g, width=12, height=6)
```


